"""
Сервис для удаления ID в скобках из текста сообщений
"""
import re


class IdCleaner:
    """Сервис для очистки текста от ID в скобках"""
    
    @staticmethod
    def remove_id_brackets(text: str) -> str:
        """
        Удаляет скобки с ID из текста.
        
        Ищет скобки (круглые, квадратные или фигурные), внутри которых есть:
        - Текст "ID" (регистронезависимо)
        - Набор цифр (обычно 7-8 цифр)
        
        Может быть в разных форматах:
        - (ID: 3409600)
        - (ID 16699751)
        - (ID3409600)
        - [ID: 3409600]
        - {ID: 3409600}
        
        Args:
            text: Текст с ID в скобках
            
        Returns:
            Текст без скобок с ID
        """
        if not text:
            return text
        
        # Сохраняем оригинальный текст для сравнения
        original_text = text
        
        # Паттерн для поиска ID в скобках
        # Ищем открывающую скобку, затем "ID" (регистронезависимо),
        # затем опционально пробел и двоеточие, затем пробел (опционально),
        # затем цифры (обычно 7-8, но может быть и другое количество),
        # затем закрывающую скобку
        # Поддерживаем круглые, квадратные и фигурные скобки
        patterns = [
            # Круглые скобки: (ID: 3409600), (ID 16699751), (ID3409600), (ID: 1234567)
            # Ищем от 5 до 10 цифр (чтобы покрыть разные случаи)
            r'\(ID\s*:?\s*\d{5,10}\)',
            # Квадратные скобки: [ID: 3409600], [ID 16699751], [ID3409600]
            r'\[ID\s*:?\s*\d{5,10}\]',
            # Фигурные скобки: {ID: 3409600}, {ID 16699751}, {ID3409600}
            r'\{ID\s*:?\s*\d{5,10}\}',
        ]
        
        result = text
        removed_count = 0
        for pattern in patterns:
            # Подсчитываем количество найденных совпадений
            matches = re.findall(pattern, result, flags=re.IGNORECASE)
            if matches:
                removed_count += len(matches)
            # Заменяем все вхождения на пустую строку
            result = re.sub(pattern, '', result, flags=re.IGNORECASE)
        
        # Удаляем возможные двойные пробелы, оставшиеся после удаления
        # Но сохраняем переносы строк
        # Заменяем множественные пробелы на один, но не трогаем переносы строк
        result = re.sub(r'[ \t]+', ' ', result)  # Заменяем пробелы и табы на один пробел
        # Удаляем пробелы перед переносами строк
        result = re.sub(r' +\n', '\n', result)
        # Удаляем пробелы после переносов строк
        result = re.sub(r'\n +', '\n', result)
        # Удаляем пробелы в начале и конце строки (но не переносы строк)
        result = result.strip()
        
        # Логируем, если что-то было удалено
        if removed_count > 0:
            import logging
            logger = logging.getLogger(__name__)
            logger.debug(f"Удалено {removed_count} ID из текста. Длина до: {len(original_text)}, после: {len(result)}")
        
        return result


def remove_id_brackets_from_text(text: str) -> str:
    """
    Удобная функция для удаления ID в скобках из текста
    
    Args:
        text: Текст с ID в скобках
    
    Returns:
        Текст без скобок с ID
    """
    return IdCleaner.remove_id_brackets(text)

