"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –≤ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
"""
from typing import Optional
from ..storage.checkpointer import get_postgres_checkpointer
from .logger_service import logger


async def is_first_user_message(chat_id: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–∏–∞–ª–æ–≥–µ.
    
    –£—á–∏—Ç—ã–≤–∞–µ—Ç, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ AI —Å–æ–æ–±—â–µ–Ω–∏—è (tool calls).
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏–∏:
    - –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ–∫—É—â–µ–µ) - —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    - –ï—Å–ª–∏ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ - –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–æ–µ
    
    Args:
        chat_id: ID —á–∞—Ç–∞ –≤ Telegram
        
    Returns:
        True, –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, False –∏–Ω–∞—á–µ
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º telegram_user_id –∏–∑ chat_id
        try:
            telegram_user_id = int(chat_id)
        except ValueError:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å chat_id={chat_id} –≤ telegram_user_id")
            return False
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ checkpointer
        async with get_postgres_checkpointer() as checkpointer:
            config = {"configurable": {"thread_id": str(telegram_user_id)}}
            
            logger.info(f"üîç [GREETING] –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ checkpointer –¥–ª—è thread_id={telegram_user_id}, chat_id={chat_id}")
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            state_snapshot = await checkpointer.aget(config)
            
            if not state_snapshot:
                # –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                logger.info(f"üîç [GREETING] –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ checkpointer, —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (chat_id={chat_id})")
                return True
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º messages –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            # state_snapshot –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–≤–∞—Ä–µ–º –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º
            if isinstance(state_snapshot, dict):
                values = state_snapshot.get("values", {})
            else:
                # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ values –∞—Ç—Ä–∏–±—É—Ç–æ–º –∏–ª–∏ –º–µ—Ç–æ–¥–æ–º
                if hasattr(state_snapshot, 'values'):
                    values_attr = getattr(state_snapshot, 'values')
                    # –ï—Å–ª–∏ values - —ç—Ç–æ –º–µ—Ç–æ–¥ (callable), –≤—ã–∑—ã–≤–∞–µ–º –µ–≥–æ
                    if callable(values_attr):
                        values = values_attr()
                    else:
                        values = values_attr
                else:
                    # –ï—Å–ª–∏ –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ values, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å
                    values = getattr(state_snapshot, 'values', {})
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ values - —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å
            if not isinstance(values, dict):
                logger.error(f"values –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä–µ–º: {type(values)}, chat_id={chat_id}")
                return False
            
            messages = values.get("messages", [])
            
            logger.info(f"üîç [GREETING] –ò–∑–≤–ª–µ—á–µ–Ω–æ messages –∏–∑ values, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(messages) if messages else 0} (chat_id={chat_id})")
            
            if not messages:
                # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø–µ—Ä–≤–æ–µ
                logger.info(f"üîç [GREETING] –°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏, —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (chat_id={chat_id})")
                return True
            
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # –í –º–æ–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —É–∂–µ –µ—Å—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            user_messages_count = 0
            # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ AI (–±–µ–∑ tool calls) - –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            final_ai_responses_count = 0
            
            logger.info(f"üîç [GREETING] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è chat_id={chat_id}, –≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏: {len(messages)}")
            
            for i, msg in enumerate(messages):
                # –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
                msg_type = None
                
                # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç BaseMessage
                if hasattr(msg, 'type'):
                    msg_type = msg.type
                # –ï—Å–ª–∏ —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å
                elif isinstance(msg, dict):
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–µ type
                    msg_type = msg.get('type', '')
                    # –ï—Å–ª–∏ type –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∫–ª–∞—Å—Å—É –∏–ª–∏ role
                    if not msg_type:
                        # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ role
                        role = msg.get('role', '')
                        if role == 'user':
                            msg_type = 'human'
                        elif role == 'assistant':
                            msg_type = 'ai'
                        elif role == 'tool':
                            msg_type = 'tool'
                        elif role == 'system':
                            msg_type = 'system'
                # –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                elif isinstance(msg, str):
                    continue
                
                # –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                if i < 5:
                    content_preview = 'N/A'
                    if hasattr(msg, 'content'):
                        content_preview = str(msg.content)[:50]
                    elif isinstance(msg, dict):
                        content_preview = str(msg.get('content', ''))[:50]
                    logger.info(f"üîç [GREETING] –°–æ–æ–±—â–µ–Ω–∏–µ [{i}]: type={msg_type}, class={type(msg).__name__}, content_preview={content_preview}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                # HumanMessage –∏–º–µ–µ—Ç type='human', –Ω–æ —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å 'user' –≤ —Å–ª–æ–≤–∞—Ä—è—Ö
                if msg_type in ['human', 'user']:
                    user_messages_count += 1
                    logger.info(f"üîç [GREETING] –ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [{i}]: type={msg_type}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã AI (–±–µ–∑ tool calls)
                # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã AI, –∑–Ω–∞—á–∏—Ç —É–∂–µ –±—ã–ª –¥–∏–∞–ª–æ–≥
                if msg_type in ['ai', 'assistant']:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ tool_calls –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
                    has_tool_calls = False
                    if hasattr(msg, 'tool_calls') and msg.tool_calls:
                        has_tool_calls = True
                    elif isinstance(msg, dict) and msg.get('tool_calls'):
                        has_tool_calls = True
                    
                    # –ï—Å–ª–∏ –Ω–µ—Ç tool_calls, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É
                    if not has_tool_calls:
                        final_ai_responses_count += 1
                        logger.info(f"üîç [GREETING] –ù–∞–π–¥–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç AI [{i}]: type={msg_type}")
            
            logger.info(f"üîç [GREETING] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_messages_count}, —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ AI: {final_ai_responses_count} (chat_id={chat_id})")
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user_messages_count > 1),
            # –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã AI (final_ai_responses_count > 1, —É—á–∏—Ç—ã–≤–∞—è —Ç–µ–∫—É—â–∏–π),
            # –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            # –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏,
            # –ø–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ user_messages_count > 1, –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if user_messages_count > 1:
                # –ï—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–æ–µ
                logger.info(f"üîç [GREETING] –ù–∞–π–¥–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({user_messages_count} —à—Ç), —ç—Ç–æ –ù–ï –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (chat_id={chat_id})")
                return False
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ AI (—Ç–µ–∫—É—â–∏–π + –ø—Ä–µ–¥—ã–¥—É—â–∏–µ), –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–æ–µ
            if final_ai_responses_count > 1:
                logger.info(f"üîç [GREETING] –ù–∞–π–¥–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã AI ({final_ai_responses_count} —à—Ç), —ç—Ç–æ –ù–ï –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (chat_id={chat_id})")
                return False
            
            # –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ–∫—É—â–µ–µ) –∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç AI (—Ç–µ–∫—É—â–∏–π),
            # –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            logger.info(f"üîç [GREETING] –≠—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user_messages_count={user_messages_count}, final_ai_responses={final_ai_responses_count}, chat_id={chat_id})")
            return True
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º False, —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        return False


def has_greeting(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    
    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        
    Returns:
        True, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, False –∏–Ω–∞—á–µ
    """
    if not text:
        return False
    
    # –ü—Ä–∏–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    text_lower = text.lower().strip()
    
    # –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    greetings = [
        "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å",
        "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
        "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä",
        "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ",
        "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π",
        "–ø—Ä–∏–≤–µ—Ç",
        "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é",
        "–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫",
        "–¥–æ–±—Ä–æ–≥–æ –¥–Ω—è",
        "–¥–æ–±—Ä–æ–≥–æ —É—Ç—Ä–∞",
        "–¥–æ–±—Ä–æ–≥–æ –≤–µ—á–µ—Ä–∞"
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    for greeting in greetings:
        if text_lower.startswith(greeting):
            return True
    
    # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –ø–µ—Ä–≤—ã—Ö 50 —Å–∏–º–≤–æ–ª–∞—Ö
    # (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ)
    text_start = text_lower[:50]
    for greeting in greetings:
        if greeting in text_start:
            return True
    
    return False


async def add_greeting_if_needed(text: str, chat_id: str, is_first_message: bool = None) -> str:
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" –≤ –Ω–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏:
    1. –≠—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    2. –í —Ç–µ–∫—Å—Ç–µ –µ—â–µ –Ω–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    
    Args:
        text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–≥–µ–Ω—Ç–∞
        chat_id: ID —á–∞—Ç–∞ –≤ Telegram
        is_first_message: –§–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        
    Returns:
        –¢–µ–∫—Å—Ç —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏–ª–∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
    """
    logger.info(f"üîç [GREETING] –í—ã–∑–æ–≤ add_greeting_if_needed –¥–ª—è chat_id={chat_id}, –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(text) if text else 0}, is_first_message={is_first_message}")
    
    if not text or not text.strip():
        logger.info(f"üîç [GREETING] –¢–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (chat_id={chat_id})")
        return text
    
    try:
        logger.info(f"üîç [GREETING] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è chat_id={chat_id}, –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(text)}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        if is_first_message is None:
            # –ï—Å–ª–∏ —Ñ–ª–∞–≥ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ checkpointer
            is_first = await is_first_user_message(chat_id)
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Ñ–ª–∞–≥
            is_first = is_first_message
        logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: is_first={is_first} (chat_id={chat_id})")
        
        if not is_first:
            # –ù–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            logger.debug(f"–ù–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è (chat_id={chat_id})")
            return text
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —Ç–µ–∫—Å—Ç–µ
        has_greeting_result = has_greeting(text)
        logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –≤ —Ç–µ–∫—Å—Ç–µ: has_greeting={has_greeting_result} (chat_id={chat_id})")
        
        if has_greeting_result:
            # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —É–∂–µ –µ—Å—Ç—å - –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
            logger.info(f"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º (chat_id={chat_id})")
            return text
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –Ω–∞—á–∞–ª–æ
        greeting = "–î–æ–±—Ä—ã–π –¥–µ–Ω—å!"
        result = f"{greeting}\n\n{text}"
        logger.info(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, chat_id={chat_id}, –¥–ª–∏–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: {len(result)}")
        return result
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: {e}", exc_info=True)
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
        return text

