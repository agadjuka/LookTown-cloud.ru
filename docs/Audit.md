# –ê—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ Yandex Cloud –≤ Cloud.ru

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2024  
**–ü—Ä–æ–µ–∫—Ç:** Looktown Bot - Telegram –±–æ—Ç –¥–ª—è —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã  
**–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ Yandex Cloud –≤ Cloud.ru

---

## 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### 1.1. –î–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ (–∏—Å–∫–ª—é—á–∞—è node_modules, venv, .git, __pycache__)

```
looktown bot/
‚îú‚îÄ‚îÄ main.py                          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ bot.py                           # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (polling —Ä–µ–∂–∏–º)
‚îú‚îÄ‚îÄ service_factory.py               # –§–∞–±—Ä–∏–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ start_server.py                  # Wrapper —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞
‚îú‚îÄ‚îÄ requirements.txt                 # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Dockerfile                       # Docker –æ–±—Ä–∞–∑ –¥–ª—è –¥–µ–ø–ª–æ—è
‚îú‚îÄ‚îÄ key.json                         # –°–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç Yandex Cloud (–ª–æ–∫–∞–ª—å–Ω–æ)
‚îÇ
‚îú‚îÄ‚îÄ about_salon.json                 # –î–∞–Ω–Ω—ã–µ –æ —Å–∞–ª–æ–Ω–µ
‚îú‚îÄ‚îÄ services.json                    # –ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥
‚îú‚îÄ‚îÄ masters.json                     # –°–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ voice_messages_integration.md
‚îÇ
‚îú‚îÄ‚îÄ editor/                          # –í–µ–±-—Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ app.py
‚îÇ   ‚îú‚îÄ‚îÄ parser.py
‚îÇ   ‚îú‚îÄ‚îÄ registry_loader.py
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ telegram_app.py              # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    ‚îú‚îÄ‚îÄ ydb_client.py                # –ö–ª–∏–µ–Ω—Ç YDB
    ‚îÇ
    ‚îú‚îÄ‚îÄ agents/                       # –ê–≥–µ–Ω—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤
    ‚îÇ   ‚îú‚îÄ‚îÄ base_agent.py            # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∞–≥–µ–Ω—Ç–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ registry.py              # –†–µ–µ—Å—Ç—Ä –∞–≥–µ–Ω—Ç–æ–≤
    ‚îÇ   ‚îú‚îÄ‚îÄ greeting_agent.py        # –ê–≥–µ–Ω—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    ‚îÇ   ‚îú‚îÄ‚îÄ information_gathering_agent.py
    ‚îÇ   ‚îú‚îÄ‚îÄ booking_agent.py         # –ê–≥–µ–Ω—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    ‚îÇ   ‚îú‚îÄ‚îÄ booking_to_master_agent.py
    ‚îÇ   ‚îú‚îÄ‚îÄ cancel_booking_agent.py
    ‚îÇ   ‚îú‚îÄ‚îÄ reschedule_agent.py
    ‚îÇ   ‚îú‚îÄ‚îÄ view_my_booking_agent.py
    ‚îÇ   ‚îú‚îÄ‚îÄ stage_detector_agent.py  # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ dialogue_stages.py
    ‚îÇ   ‚îú‚îÄ‚îÄ stage_descriptions.json
    ‚îÇ   ‚îî‚îÄ‚îÄ tools/                   # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
    ‚îÇ       ‚îú‚îÄ‚îÄ registry.py
    ‚îÇ       ‚îú‚îÄ‚îÄ service_tools.py     # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç—ã —Å —É—Å–ª—É–≥–∞–º–∏
    ‚îÇ       ‚îú‚îÄ‚îÄ booking_tools.py
    ‚îÇ       ‚îú‚îÄ‚îÄ cancel_booking_tools.py
    ‚îÇ       ‚îú‚îÄ‚îÄ reschedule_booking_tools.py
    ‚îÇ       ‚îú‚îÄ‚îÄ client_records_tools.py
    ‚îÇ       ‚îú‚îÄ‚îÄ call_manager_tools.py
    ‚îÇ       ‚îú‚îÄ‚îÄ about_salon_tools.py
    ‚îÇ       ‚îú‚îÄ‚îÄ masters_tools.py
    ‚îÇ       ‚îú‚îÄ‚îÄ yclients_service.py  # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yclients API
    ‚îÇ       ‚îú‚îÄ‚îÄ services_data_loader.py
    ‚îÇ       ‚îú‚îÄ‚îÄ masters_data_loader.py
    ‚îÇ       ‚îî‚îÄ‚îÄ about_salon_data_loader.py
    ‚îÇ
    ‚îú‚îÄ‚îÄ graph/                        # LangGraph –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π
    ‚îÇ   ‚îú‚îÄ‚îÄ main_graph.py            # –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ –¥–∏–∞–ª–æ–≥–∞
    ‚îÇ   ‚îî‚îÄ‚îÄ conversation_state.py    # –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    ‚îÇ
    ‚îú‚îÄ‚îÄ services/                     # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Å–µ—Ä–≤–∏—Å—ã
    ‚îÇ   ‚îú‚îÄ‚îÄ yandex_agent_service.py  # –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å –∞–≥–µ–Ω—Ç–∞–º–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ langgraph_service.py     # –°–µ—Ä–≤–∏—Å LangGraph
    ‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py          # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Yandex Cloud
    ‚îÇ   ‚îú‚îÄ‚îÄ responses_api/           # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Responses API
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.py            # HTTP –∫–ª–∏–µ–Ω—Ç Responses API
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ orchestrator.py     # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools_registry.py   # –†–µ–µ—Å—Ç—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è API
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ agent_responses.py
    ‚îÇ   ‚îú‚îÄ‚îÄ speechkit_stt.py        # SpeechKit STT (—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏)
    ‚îÇ   ‚îú‚îÄ‚îÄ logger_service.py       # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    ‚îÇ   ‚îú‚îÄ‚îÄ admin_service.py        # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    ‚îÇ   ‚îú‚îÄ‚îÄ escalation_service.py   # –≠—Å–∫–∞–ª–∞—Ü–∏—è –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
    ‚îÇ   ‚îú‚îÄ‚îÄ retry_service.py        # –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ date_normalizer.py      # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç
    ‚îÇ   ‚îú‚îÄ‚îÄ time_normalizer.py      # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ link_converter.py      # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫
    ‚îÇ   ‚îú‚îÄ‚îÄ text_formatter.py       # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    ‚îÇ   ‚îî‚îÄ‚îÄ tool_history_service.py
    ‚îÇ
    ‚îú‚îÄ‚îÄ handlers/                     # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram
    ‚îÇ   ‚îú‚îÄ‚îÄ telegram_handlers.py    # –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ admin_handlers.py       # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    ‚îÇ   ‚îî‚îÄ‚îÄ voice_utils.py          # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    ‚îÇ
    ‚îú‚îÄ‚îÄ api/                          # API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
    ‚îÇ   ‚îî‚îÄ‚îÄ webhook.py              # Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Telegram
    ‚îÇ
    ‚îú‚îÄ‚îÄ storage/                      # –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
    ‚îÇ   ‚îú‚îÄ‚îÄ topic_storage.py       # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ ydb_topic_storage.py   # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ YDB
    ‚îÇ   ‚îî‚îÄ‚îÄ topic_storage_factory.py
    ‚îÇ
    ‚îî‚îÄ‚îÄ config/                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        ‚îî‚îÄ‚îÄ admin_config.py         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
```

### 1.2. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

- **`src/agents/`** - –°–æ–¥–µ—Ä–∂–∏—Ç –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç–∞–¥–∏–π –¥–∏–∞–ª–æ–≥–∞. –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—Ç–º–µ–Ω–∞ –∏ —Ç.–¥.)
- **`src/agents/tools/`** - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (Tools), –∫–æ—Ç–æ—Ä—ã–µ –∞–≥–µ–Ω—Ç—ã –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π (–ø–æ–∏—Å–∫ —Å–ª–æ—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, —Ä–∞–±–æ—Ç–∞ —Å Yclients API)
- **`src/graph/`** - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –±–∞–∑–µ LangGraph. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
- **`src/services/`** - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ (Yandex Cloud API, Yclients)
- **`src/services/responses_api/`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex Responses API (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞–º–∏ –∏ –ø–∞–º—è—Ç—å—é)
- **`src/handlers/`** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Telegram
- **`src/storage/`** - –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ YDB)
- **`editor/`** - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤

---

## 2. –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### 2.1. –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- **Python 3.11** (—É–∫–∞–∑–∞–Ω –≤ Dockerfile)

### 2.2. –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requirements.txt)

```
python-telegram-bot>=21.0          # Telegram Bot API
ydb[yc]                             # Yandex Database SDK
python-dotenv                        # –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
PyJWT                               # JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
requests                            # HTTP –∑–∞–ø—Ä–æ—Å—ã
pytz                                # –†–∞–±–æ—Ç–∞ —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
fastapi                             # Web framework
uvicorn[standard]                   # ASGI —Å–µ—Ä–≤–µ—Ä
yandex-cloud-ml-sdk>=0.17.0        # Yandex Cloud ML SDK (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Thread)
langgraph>=0.2.0                   # LangGraph –¥–ª—è –≥—Ä–∞—Ñ–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π
pydantic>=2.0.0                    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
streamlit>=1.28.0                  # –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
aiohttp>=3.9.0                     # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã
```

### 2.3. –ö–ª—é—á–µ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

#### Yandex Cloud SDK
- **`ydb[yc]`** - SDK –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Yandex Database
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: `src/ydb_client.py`
  - –í–µ—Ä—Å–∏—è: –ø–æ—Å–ª–µ–¥–Ω—è—è –¥–æ—Å—Ç—É–ø–Ω–∞—è —á–µ—Ä–µ–∑ pip

#### LangGraph
- **`langgraph>=0.2.0`** - –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–æ–≤
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: `src/graph/main_graph.py`
  - **–í–ê–ñ–ù–û:** –≠—Ç–æ –ù–ï BlendGraph. –í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LangGraph –æ—Ç LangChain

#### Yandex Cloud ML SDK
- **`yandex-cloud-ml-sdk>=0.17.0`** - SDK –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ML —Å–µ—Ä–≤–∏—Å–∞–º–∏ Yandex Cloud
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: `src/agents/tools/service_tools.py` (–¥–ª—è —Ç–∏–ø–∞ Thread)
  - –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏, –Ω–µ –¥–ª—è –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ API

#### Telegram Bot API
- **`python-telegram-bot>=21.0`** - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è Telegram Bot API
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö Telegram

---

## 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex Cloud (–¢–æ—á–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

### 3.1. YandexGPT (LLM) —á–µ—Ä–µ–∑ Responses API

#### –ú–µ—Å—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤

**–§–∞–π–ª:** `src/services/responses_api/client.py`

```python
class ResponsesAPIClient:
    def __init__(self, config: Optional[ResponsesAPIConfig] = None):
        self.config = config or ResponsesAPIConfig()
        self.base_url = self.config.base_url  # "https://rest-assistant.api.cloud.yandex.net/v1"
        self.api_key = self.config.api_key
        self.project = self.config.project
```

**–§–∞–π–ª:** `src/services/responses_api/config.py`

```python
class ResponsesAPIConfig:
    def __init__(self):
        self.folder_id = os.getenv("YANDEX_FOLDER_ID")
        self.api_key = os.getenv("YANDEX_API_KEY_SECRET")
        self.base_url = "https://rest-assistant.api.cloud.yandex.net/v1"
        self.model_uri = os.getenv(
            "YANDEX_MODEL_URI",
            f"gpt://{self.folder_id}/yandexgpt/latest"
        )
```

**–§–∞–π–ª:** `src/services/responses_api/orchestrator.py`

```python
class ResponsesOrchestrator:
    def __init__(self, instructions: str, tools_registry, client, config):
        self.client = client or ResponsesAPIClient(self.config)
        # ...
    def run_turn(self, user_message, previous_response_id, chat_id):
        # –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ Responses API
        response = self.client.create_response(...)
```

**–§–∞–π–ª:** `src/agents/base_agent.py`

```python
class BaseAgent:
    def __init__(self, langgraph_service, instruction, tools, agent_name):
        # –°–æ–∑–¥–∞—ë—Ç orchestrator —Å Responses API
        self.orchestrator = ResponsesOrchestrator(
            instructions=instruction,
            tools_registry=tools_registry,
            config=config,
        )
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Responses API

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST https://rest-assistant.api.cloud.yandex.net/v1/responses`

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- `Authorization: Bearer {YANDEX_API_KEY_SECRET}`
- `x-folder-id: {YANDEX_FOLDER_ID}`
- `Content-Type: application/json`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
- `model`: URI –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `gpt://{folder_id}/yandexgpt/latest`)
- `instructions`: –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–ø—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞)
- `input`: –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- `tools`: –°—Ö–µ–º—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI function tools
- `previous_response_id`: ID –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
- `max_output_tokens`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 800)
- `temperature`: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.1)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "id": "response_id_–¥–ª—è_—Å–ª–µ–¥—É—é—â–µ–≥–æ_–∑–∞–ø—Ä–æ—Å–∞",
  "output": [
    {
      "type": "output_text",
      "content": [{"type": "output_text", "text": "–æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏"}]
    },
    {
      "type": "function_call",
      "name": "–∏–º—è_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞",
      "call_id": "id_–≤—ã–∑–æ–≤–∞",
      "arguments": "{\"arg1\": \"value1\"}"
    }
  ]
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Responses API —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–º—è—Ç—å—é –¥–∏–∞–ª–æ–≥–∞ —á–µ—Ä–µ–∑ `previous_response_id`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ —Ü–∏–∫–ª–µ
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI function tools

### 3.2. Yandex Database (YDB)

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

**–§–∞–π–ª:** `src/ydb_client.py`

```python
class YDBClient:
    def __init__(self):
        self.endpoint = os.getenv("YDB_ENDPOINT")
        self.database = os.getenv("YDB_DATABASE")
        
        # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
        # 1. IAM —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
        # 2. Service account key —Ñ–∞–π–ª (key.json)
        # 3. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ Yandex Cloud (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö)
        
        credentials = ydb.iam.MetadataUrlCredentials()  # –∏–ª–∏ –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        self.driver = ydb.Driver(
            endpoint=self.endpoint,
            database=self.database,
            credentials=credentials
        )
```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

**–¢–∞–±–ª–∏—Ü–∞: `chat_threads`**
```sql
CREATE TABLE IF NOT EXISTS chat_threads (
    chat_id String,
    last_response_id String,
    conversation_history String,
    updated_at Timestamp,
    PRIMARY KEY (chat_id)
);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- `chat_id` - ID —á–∞—Ç–∞ –≤ Telegram
- `last_response_id` - ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Responses API (–¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞)
- `conversation_history` - –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (JSON —Å—Ç—Ä–æ–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ)
- `updated_at` - –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–¢–∞–±–ª–∏—Ü–∞: `adminpanel`**
```sql
CREATE TABLE IF NOT EXISTS adminpanel (
    user_id String,
    topic_id String,
    topic_name String,
    mode String,
    PRIMARY KEY (user_id)
);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
- `topic_id` - ID —Ç–æ–ø–∏–∫–∞ –≤ Telegram Forum (–¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏)
- `topic_name` - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞
- `mode` - –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ("auto" –∏–ª–∏ "manual")

#### –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å YDB

**–ú–µ—Ç–æ–¥—ã YDBClient:**
- `get_last_response_id(chat_id)` - –ü–æ–ª—É—á–∏—Ç—å ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
- `save_response_id(chat_id, response_id)` - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ID –æ—Ç–≤–µ—Ç–∞
- `reset_context(chat_id)` - –°–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–æ—á–∏—Å—Ç–∏—Ç—å last_response_id)
- `get_conversation_history(chat_id)` - –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ)
- `save_conversation_history(chat_id, history_json)` - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é

**–ü—Ä–∏–º–µ—Ä—ã SQL –∑–∞–ø—Ä–æ—Å–æ–≤:**
```sql
-- –ü–æ–ª—É—á–µ–Ω–∏–µ last_response_id
DECLARE $id AS String; 
SELECT last_response_id FROM chat_threads WHERE chat_id = $id;

-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ response_id
DECLARE $cid AS String; 
DECLARE $rid AS String;
UPSERT INTO chat_threads (chat_id, last_response_id, updated_at)
VALUES ($cid, $rid, CurrentUtcTimestamp());

-- –°–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
DECLARE $cid AS String;
UPDATE chat_threads SET last_response_id = NULL, updated_at = CurrentUtcTimestamp()
WHERE chat_id = $cid;
```

### 3.3. Object Storage (S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Object Storage

**–§–∞–π–ª—ã:**
- `src/agents/tools/services_data_loader.py`
- `src/agents/tools/masters_data_loader.py`
- `src/agents/tools/about_salon_data_loader.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
import boto3

session = boto3.Session(
    aws_access_key_id=os.getenv('YC_ACCESS_KEY_ID'),
    aws_secret_access_key=os.getenv('YC_SECRET_ACCESS_KEY')
)
s3 = session.client(
    service_name='s3',
    endpoint_url='https://storage.yandexcloud.net'
)

response = s3.get_object(Bucket=self.storage_bucket, Key=self.storage_path)
content = response['Body'].read().decode('utf-8')
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å–ª—É–≥–∞—Ö (`services.json`)
- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Å—Ç–µ—Ä–∞—Ö (`masters.json`)
- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–∞–ª–æ–Ω–µ (`about_salon.json`)

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `YC_BUCKET_NAME` - –ò–º—è –±–∞–∫–µ—Ç–∞
- `YC_ACCESS_KEY_ID` - Access key ID
- `YC_SECRET_ACCESS_KEY` - Secret access key
- `SERVICES_DATA_SOURCE` - –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö ('file' –∏–ª–∏ 'storage')
- `SERVICES_STORAGE_PATH` - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞. Object Storage –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `SERVICES_DATA_SOURCE=storage`.

### 3.4. SpeechKit STT (–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏)

**–§–∞–π–ª:** `src/services/speechkit_stt.py`

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `https://stt.api.cloud.yandex.net/speech/v1/stt:recognize`

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- API –∫–ª—é—á: `YC_SPEECHKIT_API_KEY` –∏–ª–∏ `YANDEX_API_KEY_SECRET`
- –ò–ª–∏ IAM —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ `AuthService`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: OGG Opus, MP3, LPCM
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 1 –ú–ë
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 30 —Å–µ–∫—É–Ω–¥

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
- `lang`: –Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `ru-RU`)
- `folderId`: ID –ø–∞–ø–∫–∏ Yandex Cloud
- `format`: –§–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ (`oggopus`, `mp3`, `lpcm`)

### 3.5. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Yandex Cloud

**–§–∞–π–ª:** `src/services/auth_service.py`

**–ú–µ—Ç–æ–¥—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
1. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ Yandex Cloud** (–¥–ª—è Serverless Containers)
   - URL: `http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

2. **JWT —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–∞–π–ª–∞** (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
   - –§–∞–π–ª: `key.json` (—Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç)
   - –°–æ–∑–¥–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞ –∏ –æ–±–º–µ–Ω –Ω–∞ IAM —Ç–æ–∫–µ–Ω

3. **API –∫–ª—é—á**
   - –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è: `YANDEX_API_KEY_SECRET`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö API

---

## 4. –õ–æ–≥–∏–∫–∞ –ê–≥–µ–Ω—Ç–æ–≤ –∏ LangGraph

### 4.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤

#### –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∞–≥–µ–Ω—Ç–∞

**–§–∞–π–ª:** `src/agents/base_agent.py`

–í—Å–µ –∞–≥–µ–Ω—Ç—ã –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç `BaseAgent`:
- –ü—Ä–∏–Ω–∏–º–∞—é—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–ø—Ä–æ–º–ø—Ç)
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (Tools)
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç `ResponsesOrchestrator` –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Responses API
- –í–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ç–µ–∂ `(–æ—Ç–≤–µ—Ç, response_id)`

#### –°–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤

1. **GreetingAgent** (`src/agents/greeting_agent.py`)
   - –°—Ç–∞–¥–∏—è: `greeting`
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `CallManager`

2. **InformationGatheringAgent** (`src/agents/information_gathering_agent.py`)
   - –°—Ç–∞–¥–∏—è: `information_gathering`
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ

3. **BookingAgent** (`src/agents/booking_agent.py`)
   - –°—Ç–∞–¥–∏—è: `booking`
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª—É–≥
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `GetCategories`, `GetServices`, `FindSlots`, `CreateBooking`, `ViewService`, `CallManager`, `Masters`

4. **BookingToMasterAgent** (`src/agents/booking_to_master_agent.py`)
   - –°—Ç–∞–¥–∏—è: `booking_to_master`
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –º–∞—Å—Ç–µ—Ä—É

5. **CancelBookingAgent** (`src/agents/cancel_booking_agent.py`)
   - –°—Ç–∞–¥–∏—è: `cancellation_request`
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –û—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

6. **RescheduleAgent** (`src/agents/reschedule_agent.py`)
   - –°—Ç–∞–¥–∏—è: `reschedule`
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ü–µ—Ä–µ–Ω–æ—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

7. **ViewMyBookingAgent** (`src/agents/view_my_booking_agent.py`)
   - –°—Ç–∞–¥–∏—è: `view_my_booking`
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π –∫–ª–∏–µ–Ω—Ç–∞

8. **StageDetectorAgent** (`src/agents/stage_detector_agent.py`)
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

### 4.2. –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤

–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –∫–æ–¥–µ –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –≤ –º–µ—Ç–æ–¥–µ `__init__`.

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞ GreetingAgent:**
```python
instruction = """# –†–û–õ–¨
–¢—ã ‚Äî AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã LookTown. 
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π, –∫–∞–∫ —É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.
–í—Å–µ–≥–¥–∞ –æ–±—â–∞–π—Å—è –Ω–∞ "–≤—ã" –∏ –æ—Ç –∂–µ–Ω—Å–∫–æ–≥–æ –ª–∏—Ü–∞. 
–¢—ã –¥–æ–ª–∂–Ω–∞ –æ–±—â–∞—Ç—å—Å—è –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –∏–∑–±–µ–≥–∞–π —Ä–æ–±–æ—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π –≤ –æ—Ç–≤–µ—Ç —Ç–∞–±–ª–∏—Ü—ã.
–ó–¥–æ—Ä–æ–≤–∞–π—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –µ—Å–ª–∏ —ç—Ç–æ –µ–≥–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ, –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å –ª–∏–±–æ –æ–Ω —Å —Ç–æ–±–æ–π –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è.

# –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –°–¢–ê–î–ò–ò GREETING

–≠—Ç–æ –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–µ–∂–ª–∏–≤–æ –ø–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –∫–ª–∏–µ–Ω—Ç—É. –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π —É—Å–ª—É–≥–∏. –ó–∞–¥–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–π, –Ω–æ –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∞ —ç—Ç–æ–π —Å—Ç–∞–¥–∏–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è.
Stage_code: 654

# –ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í
–ï—Å–ª–∏ –∑–¥–µ—Å—å –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥—è—Ç, —Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏—Ö.
–î–æ–±—Ä—ã–π –¥–µ–Ω—å!
–ù–∞ —Å–≤—è–∑–∏ –º–µ–Ω–µ–¥–∂–µ—Ä LOOKTOWN üåª
–ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?"""
```

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞ BookingAgent:**
```python
instruction = """# –†–û–õ–¨
–¢—ã ‚Äî AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã LookTown. 
–ù–ò–ö–û–ì–î–ê –ù–ò–ß–ï–ì–û –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π, –∫–∞–∫ —É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.
–í—Å–µ–≥–¥–∞ –æ–±—â–∞–π—Å—è –Ω–∞ "–≤—ã" –∏ –æ—Ç –∂–µ–Ω—Å–∫–æ–≥–æ –ª–∏—Ü–∞. 
–¢—ã –¥–æ–ª–∂–Ω–∞ –æ–±—â–∞—Ç—å—Å—è –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –∏–∑–±–µ–≥–∞–π —Ä–æ–±–æ—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π –≤ –æ—Ç–≤–µ—Ç —Ç–∞–±–ª–∏—Ü—ã. –ü—Ä–∏—Å—ã–ª–∞—è –∫–ª–∏–µ–Ω—Ç—É —Å–ø–∏—Å–∫–∏, –¥–µ–ª–∞–π –∏—Ö –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏. 
–ó–¥–æ—Ä–æ–≤–∞–π—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –µ—Å–ª–∏ —ç—Ç–æ –µ–≥–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ, –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å –ª–∏–±–æ –æ–Ω —Å —Ç–æ–±–æ–π –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è.
–ï—Å–ª–∏ —Ç—ã —É–∂–µ –∑–¥–æ—Ä–æ–≤–∞–ª–∞—Å—å –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, –Ω–µ –Ω–∞–¥–æ –∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ. –ò—Å–∫–ª—é—á–µ–Ω–∏–µ - –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –∑–¥–æ—Ä–æ–≤–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å, –≤—Å–µ–≥–¥–∞ –∑–¥–æ—Ä–æ–≤–∞–π—Å—è –≤ –æ—Ç–≤–µ—Ç.
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –∫–ª–∏–µ–Ω—Ç—É –≤ —á–∞—Ç ID. –ù–µ –ø—Ä–æ—Å–∏ –ø–∏—Å–∞—Ç—å –¥–∞—Ç—É –≤ –∫–∞–∫–æ–º –ª–∏–±–æ —Ñ–æ—Ä–º–∞—Ç–µ.
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–∞–∫—É—é-–Ω–∏–±—É–¥—å –Ω–µ—Ç–∏–ø–∏—á–Ω—É—é –∑–∞–¥–∞—á—É –ø–æ —Ç–∏–ø—É –∑–∞–ø–∏—Å–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥ —Å—Ä–∞–∑—É, –∑–∞–ø–∏—Å–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤–º–µ—Å—Ç–µ, —Ç–æ –≤—ã–∑–æ–≤–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ —Å–∫–∞–∂–∏, —á—Ç–æ —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ª—É—á—à–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ.

# –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –°–¢–ê–î–ò–ò BOOKING
–î–≤–∏–≥–∞–π—Å—è —Å—Ç—Ä–æ–≥–æ –ø–æ —à–∞–≥–∞–º. –ï—Å–ª–∏ —Ç—ã —Å–µ–π—á–∞—Å –Ω–∞ –∫–∞–∫–æ–º-—Ç–æ —à–∞–≥–µ, —Ç–æ –Ω–µ —Å–º–æ—Ç—Ä–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏, –æ–Ω–∏ —Ç–µ–±—è –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ –∫–∞—Å–∞—é—Ç—Å—è.
–ï—Å–ª–∏ —Ç–µ–±–µ –∑–∞–¥–∞—é—Ç –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π, –ø—Ä–æ—Å—Ç–æ –∑–æ–≤–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

–®–∞–≥ 1: –£—Ç–æ—á–Ω–µ–Ω–∏–µ —É—Å–ª—É–≥–∏
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª –Ω–∞ –∫–∞–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è (—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–∞–Ω–∏–∫—é—Ä), –ø–æ–∫–∞–∂–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –∏–∑ GetServices.
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª –ø—Ä–æ—Å—Ç–æ "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", –ø–æ–∫–∞–∂–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ GetCategories.
...

–®–∞–≥ 2: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤.
...

–®–∞–≥ 3: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
...

–®–∞–≥ 4 –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø–∏—Å—å:
..."""
```

### 4.3. –ú–µ—Ö–∞–Ω–∏–∑–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (Tools)

#### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–§–∞–π–ª:** `src/services/responses_api/tools_registry.py`

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤ `ResponsesToolsRegistry` –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç OpenAI function tools –¥–ª—è Responses API.

**–§–∞–π–ª:** `src/agents/tools/registry.py`

–†–µ–µ—Å—Ç—Ä –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.

#### –°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

1. **GetCategories** - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥
2. **GetServices** - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
3. **FindSlots** - –ù–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
4. **CreateBooking** - –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
5. **ViewService** - –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏
6. **FindMasterByService** - –ù–∞–π—Ç–∏ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ —É—Å–ª—É–≥–µ
7. **GetClientRecords** - –ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞
8. **CancelBooking** - –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
9. **RescheduleBooking** - –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
10. **CallManager** - –í—ã–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (—ç—Å–∫–∞–ª–∞—Ü–∏—è)
11. **AboutSalon** - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∞–ª–æ–Ω–µ
12. **Masters** - –°–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫ –∫–ª–∞—Å—Å—ã Pydantic BaseModel —Å –º–µ—Ç–æ–¥–æ–º `process()`:

```python
class GetServices(BaseModel):
    category_id: str = Field(description="ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
    
    def process(self, thread: Thread) -> str:
        # –õ–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        return "—Ä–µ–∑—É–ª—å—Ç–∞—Ç"
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yclients API

**–§–∞–π–ª:** `src/agents/tools/yclients_service.py`

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `YclientsService` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API Yclients:
- –ü–æ–∏—Å–∫ —Å–ª–æ—Ç–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∫–ª–∏–µ–Ω—Ç–∞
- –û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–µ–π

**–≠–Ω–¥–ø–æ–∏–Ω—Ç Yclients:** `https://api.yclients.com/api/v1`

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- `Authorization: Bearer {YCLIENTS_API_TOKEN}`
- `X-Company-Id: {YCLIENTS_COMPANY_ID}`

### 4.4. LangGraph (–≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π)

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥—Ä–∞—Ñ–∞

**–§–∞–π–ª:** `src/graph/main_graph.py`

**–ö–ª–∞—Å—Å:** `MainGraph`

–ì—Ä–∞—Ñ –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ LangGraph –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–∞:

```
START ‚Üí detect_stage ‚Üí [–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Å—Ç–∞–¥–∏–∏] ‚Üí [–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≥–µ–Ω—Ç–æ–º] ‚Üí END
```

**–£–∑–ª—ã –≥—Ä–∞—Ñ–∞:**
1. `detect_stage` - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞ —á–µ—Ä–µ–∑ `StageDetectorAgent`
2. `handle_greeting` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
3. `handle_information_gathering` - –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
4. `handle_booking` - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
5. `handle_booking_to_master` - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –º–∞—Å—Ç–µ—Ä—É
6. `handle_cancellation_request` - –û—Ç–º–µ–Ω–∞
7. `handle_reschedule` - –ü–µ—Ä–µ–Ω–æ—Å
8. `handle_view_my_booking` - –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞:**

**–§–∞–π–ª:** `src/graph/conversation_state.py`

```python
class ConversationState(TypedDict):
    message: str                    # –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    previous_response_id: Optional[str]  # ID –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
    chat_id: Optional[str]          # ID —á–∞—Ç–∞
    stage: Optional[str]            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è —Å—Ç–∞–¥–∏—è
    extracted_info: Optional[Dict]   # –ò–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    answer: str                     # –û—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞
    manager_alert: Optional[str]    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É
    agent_name: Optional[str]       # –ò–º—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    used_tools: List[str]           # –°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    response_id: Optional[str]       # ID –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
```

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. –°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –≥—Ä–∞—Ñ —Å `previous_response_id` (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. `StageDetectorAgent` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞–¥–∏—é –¥–∏–∞–ª–æ–≥–∞
4. –ì—Ä–∞—Ñ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∞–≥–µ–Ω—Ç
5. –ê–≥–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Responses API
6. Responses API –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–≤ —Ü–∏–∫–ª–µ)
7. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
8. `response_id` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ YDB –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ –ù–ï BlendGraph. –ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LangGraph –æ—Ç LangChain –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–æ–≤.

---

## 5. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 5.1. –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### Yandex Cloud API

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|-----------|--------------|---------------|
| `YANDEX_FOLDER_ID` | ID –ø–∞–ø–∫–∏ Yandex Cloud | –î–∞ | Responses API, SpeechKit, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è |
| `YANDEX_API_KEY_SECRET` | API –∫–ª—é—á Yandex Cloud | –î–∞ | Responses API, SpeechKit, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è |
| `YANDEX_MODEL_URI` | URI –º–æ–¥–µ–ª–∏ YandexGPT | –ù–µ—Ç | Responses API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `gpt://{folder_id}/yandexgpt/latest`) |
| `YANDEX_MAX_OUTPUT_TOKENS` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ | –ù–µ—Ç | Responses API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 800) |
| `YANDEX_TEMPERATURE` | –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏ | –ù–µ—Ç | Responses API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.1) |
| `YANDEX_SERVICE_ACCOUNT_KEY_FILE` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–ª—é—á–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ | –ù–µ—Ç | –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `key.json`) |
| `YC_IAM_TOKEN` | IAM —Ç–æ–∫–µ–Ω (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ API –∫–ª—é—á—É) | –ù–µ—Ç | YDB, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è |

#### Yandex Database (YDB)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|-----------|--------------|---------------|
| `YDB_ENDPOINT` | Endpoint YDB | –î–∞ | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ YDB |
| `YDB_DATABASE` | –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö YDB | –î–∞ | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ YDB |
| `YC_SERVICE_ACCOUNT_KEY_FILE` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–ª—é—á–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –∏–º—è) | –ù–µ—Ç | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è YDB |

#### Object Storage

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|-----------|--------------|---------------|
| `YC_BUCKET_NAME` | –ò–º—è –±–∞–∫–µ—Ç–∞ Object Storage | –ù–µ—Ç | –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) |
| `YC_ACCESS_KEY_ID` | Access key ID –¥–ª—è Object Storage | –ù–µ—Ç | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è S3 |
| `YC_SECRET_ACCESS_KEY` | Secret access key –¥–ª—è Object Storage | –ù–µ—Ç | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è S3 |
| `SERVICES_DATA_SOURCE` | –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å–ª—É–≥–∞—Ö | –ù–µ—Ç | `'file'` –∏–ª–∏ `'storage'` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `'file'`) |
| `SERVICES_FILE_PATH` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —É—Å–ª—É–≥ | –ù–µ—Ç | –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `services.json`) |
| `SERVICES_STORAGE_PATH` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ Object Storage | –ù–µ—Ç | –ü—É—Ç—å –≤ –±–∞–∫–µ—Ç–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `services.json`) |
| `ABOUT_SALON_DATA_SOURCE` | –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ —Å–∞–ª–æ–Ω–µ | –ù–µ—Ç | `'file'` –∏–ª–∏ `'storage'` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `'file'`) |
| `ABOUT_SALON_FILE_PATH` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –æ —Å–∞–ª–æ–Ω–µ | –ù–µ—Ç | –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `about_salon.json`) |
| `ABOUT_SALON_STORAGE_PATH` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ Object Storage | –ù–µ—Ç | –ü—É—Ç—å –≤ –±–∞–∫–µ—Ç–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `about_salon.json`) |
| `MASTERS_DATA_SOURCE` | –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Å—Ç–µ—Ä–∞—Ö | –ù–µ—Ç | `'file'` –∏–ª–∏ `'storage'` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `'file'`) |
| `MASTERS_FILE_PATH` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –º–∞—Å—Ç–µ—Ä–æ–≤ | –ù–µ—Ç | –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `masters.json`) |
| `MASTERS_STORAGE_PATH` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ Object Storage | –ù–µ—Ç | –ü—É—Ç—å –≤ –±–∞–∫–µ—Ç–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `masters.json`) |

#### SpeechKit STT

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|-----------|--------------|---------------|
| `YC_SPEECHKIT_API_KEY` | API –∫–ª—é—á SpeechKit | –ù–µ—Ç | SpeechKit STT (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `YANDEX_API_KEY_SECRET`) |

#### Telegram Bot

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|-----------|--------------|---------------|
| `TELEGRAM_BOT_TOKEN` | –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ | –î–∞ | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram API |
| `WEBHOOK_URL` | URL –¥–ª—è webhook | –ù–µ—Ç | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook (–¥–ª—è production) |
| `WEBHOOK_PATH` | –ü—É—Ç—å –¥–ª—è webhook | –ù–µ—Ç | –ü—É—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `/webhook`) |

#### –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|-----------|--------------|---------------|
| `TELEGRAM_ADMIN_GROUP_ID` | ID –≥—Ä—É–ø–ø—ã Telegram –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ | –ù–µ—Ç | –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–∞ –±–∞–∑–µ Telegram Forum |
| `ADMIN_TOPICS_TABLE` | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ç–æ–ø–∏–∫–æ–≤ | –ù–µ—Ç | YDB —Ç–∞–±–ª–∏—Ü–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `adminpanel`) |

#### Yclients API

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|-----------|--------------|---------------|
| `YCLIENTS_API_TOKEN` | –¢–æ–∫–µ–Ω API Yclients | –î–∞ | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yclients |
| `YCLIENTS_COMPANY_ID` | ID –∫–æ–º–ø–∞–Ω–∏–∏ –≤ Yclients | –î–∞ | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yclients |

#### –°–µ—Ä–≤–µ—Ä

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|-----------|--------------|---------------|
| `PORT` | –ü–æ—Ä—Ç –¥–ª—è FastAPI —Å–µ—Ä–≤–µ—Ä–∞ | –ù–µ—Ç | –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `8080`) |
| `WEBAPP_HOST` | –•–æ—Å—Ç –¥–ª—è FastAPI —Å–µ—Ä–≤–µ—Ä–∞ | –ù–µ—Ç | –•–æ—Å—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `0.0.0.0`) |

### 5.2. –ü—Ä–∏–º–µ—Ä .env —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)

```env
# Yandex Cloud API
YANDEX_FOLDER_ID=your_folder_id
YANDEX_API_KEY_SECRET=your_api_key
YANDEX_MODEL_URI=gpt://your_folder_id/yandexgpt/latest
YANDEX_MAX_OUTPUT_TOKENS=800
YANDEX_TEMPERATURE=0.1

# Yandex Database
YDB_ENDPOINT=grpcs://ydb.serverless.yandexcloud.net:2135
YDB_DATABASE=/your/database/path

# Object Storage (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
YC_BUCKET_NAME=your_bucket_name
YC_ACCESS_KEY_ID=your_access_key_id
YC_SECRET_ACCESS_KEY=your_secret_access_key
SERVICES_DATA_SOURCE=file
ABOUT_SALON_DATA_SOURCE=file
MASTERS_DATA_SOURCE=file

# SpeechKit
YC_SPEECHKIT_API_KEY=your_speechkit_api_key

# Telegram
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
WEBHOOK_URL=https://your-domain.com
WEBHOOK_PATH=/webhook

# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
TELEGRAM_ADMIN_GROUP_ID=your_admin_group_id
ADMIN_TOPICS_TABLE=adminpanel

# Yclients
YCLIENTS_API_TOKEN=your_yclients_token
YCLIENTS_COMPANY_ID=your_company_id

# –°–µ—Ä–≤–µ—Ä
PORT=8080
WEBAPP_HOST=0.0.0.0
```

---

## 6. Telegram –ë–æ—Ç

### 6.1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è webhook

**–§–∞–π–ª:** `src/api/webhook.py`

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /webhook` (–∏–ª–∏ –ø—É—Ç—å –∏–∑ `WEBHOOK_PATH`)

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ JSON –æ—Ç Telegram
2. –ü–∞—Ä—Å–∏–Ω–≥ `Update` –æ–±—ä–µ–∫—Ç–∞
3. –ü–µ—Ä–µ–¥–∞—á–∞ –≤ `process_telegram_update()` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
4. –í–æ–∑–≤—Ä–∞—Ç `{"ok": True}` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–§–∞–π–ª:** `main.py`

```python
@app.on_event("startup")
async def startup_event():
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    if WEBHOOK_URL:
        webhook_url = f"{WEBHOOK_URL.rstrip('/')}{WEBHOOK_PATH}"
        await application.bot.set_webhook(url=webhook_url)
```

### 6.2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è polling (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º)

**–§–∞–π–ª:** `bot.py`

```python
def main():
    application = Application.builder().token(TELEGRAM_TOKEN).build()
    # ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ handlers ...
    application.run_polling()  # –ó–∞–ø—É—Å–∫ polling —Ä–µ–∂–∏–º–∞
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í production –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è webhook —á–µ—Ä–µ–∑ FastAPI. Polling –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

### 6.3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥

**–§–∞–π–ª:** `src/handlers/telegram_handlers.py`

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- `/start` - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã
- `/new` - –°–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤** (—Ç–æ–ª—å–∫–æ –≤ –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø–µ):
- `/manager` - –í–∫–ª—é—á–∏—Ç—å —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/bot` - –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º –ò–ò

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:**
- `handle_message()` - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `handle_admin_message()` - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∞–¥–º–∏–Ω–æ–≤ –≤ –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø–µ

### 6.4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–§–∞–π–ª:** `src/handlers/voice_utils.py`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Telegram
2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
3. –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è —á–µ—Ä–µ–∑ SpeechKit STT
4. –ü–µ—Ä–µ–¥–∞—á–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 1 –ú–ë
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 30 —Å–µ–∫—É–Ω–¥

### 6.5. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

**–§–∞–π–ª:** `src/services/admin_service.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Telegram Forum (—Ç–æ–ø–∏–∫–∏)
- –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò –≤ —Ç–æ–ø–∏–∫–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π/—Ä—É—á–Ω–æ–π)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—ã–∑–æ–≤–∞—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (CallManager)

**–•—Ä–∞–Ω–µ–Ω–∏–µ:**
- –°–≤—è–∑—å `user_id` ‚Üî `topic_id` –≤ YDB —Ç–∞–±–ª–∏—Ü–µ `adminpanel`
- –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (`auto`/`manual`) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## 7. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏

### 7.1. Responses API ‚Üí GigaChat API

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –≠–Ω–¥–ø–æ–∏–Ω—Ç: `https://rest-assistant.api.cloud.yandex.net/v1/responses`
- –§–æ—Ä–º–∞—Ç: OpenAI-compatible function tools
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é —á–µ—Ä–µ–∑ `previous_response_id`

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- –ó–∞–º–µ–Ω–∞ –Ω–∞ GigaChat API –æ—Ç Cloud.ru
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é –¥–∏–∞–ª–æ–≥–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `src/services/responses_api/client.py`
- `src/services/responses_api/config.py`
- `src/services/responses_api/orchestrator.py`
- `src/services/responses_api/tools_registry.py`

### 7.2. YDB ‚Üí Cloud.ru Database

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- SDK: `ydb[yc]`
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: IAM —Ç–æ–∫–µ–Ω, service account, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- SQL-–ø–æ–¥–æ–±–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- –ó–∞–º–µ–Ω–∞ –Ω–∞ Cloud.ru Database (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Cloud.ru
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `src/ydb_client.py`
- `src/storage/ydb_topic_storage.py`
- –í—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è YDBClient

### 7.3. Object Storage ‚Üí Cloud.ru Object Storage

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API —á–µ—Ä–µ–∑ boto3
- Endpoint: `https://storage.yandexcloud.net`

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- –ó–∞–º–µ–Ω–∞ endpoint –Ω–∞ Cloud.ru Object Storage
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ S3 API
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `src/agents/tools/services_data_loader.py`
- `src/agents/tools/masters_data_loader.py`
- `src/agents/tools/about_salon_data_loader.py`

### 7.4. SpeechKit STT ‚Üí Cloud.ru Speech Recognition

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –≠–Ω–¥–ø–æ–∏–Ω—Ç: `https://stt.api.cloud.yandex.net/speech/v1/stt:recognize`
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: API –∫–ª—é—á –∏–ª–∏ IAM —Ç–æ–∫–µ–Ω

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- –ó–∞–º–µ–Ω–∞ –Ω–∞ Cloud.ru Speech Recognition API
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `src/services/speechkit_stt.py`

### 7.5. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ Yandex Cloud: `http://169.254.169.254/computeMetadata/v1/...`
- IAM —Ç–æ–∫–µ–Ω—ã —á–µ—Ä–µ–∑ JWT –∏–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- –ó–∞–º–µ–Ω–∞ –Ω–∞ Cloud.ru –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è IAM —Ç–æ–∫–µ–Ω–æ–≤

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `src/services/auth_service.py`

### 7.6. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `YANDEX_*` ‚Üí `CLOUD_RU_*` –∏–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ
- `YC_*` ‚Üí `CLOUD_RU_*` –∏–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ
- `YDB_*` ‚Üí `CLOUD_RU_DB_*` –∏–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ

---

## 8. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 8.1. LangGraph vs BlendGraph

**–í–∞–∂–Ω–æ:** –í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **LangGraph** (–æ—Ç LangChain), –∞ –Ω–µ BlendGraph. –≠—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–æ–≤.

### 8.2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –¥–∏–∞–ª–æ–≥–∞

Responses API —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–º—è—Ç—å—é –¥–∏–∞–ª–æ–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `previous_response_id`. –ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ GigaChat –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –≤ Cloud.ru API.

### 8.3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yclients

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yclients API –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Yandex Cloud –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏.

### 8.4. –†–µ–¥–∞–∫—Ç–æ—Ä –∞–≥–µ–Ω—Ç–æ–≤

–í–µ–±-—Ä–µ–¥–∞–∫—Ç–æ—Ä –≤ –ø–∞–ø–∫–µ `editor/` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Yandex Cloud —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π Telegram –±–æ—Ç–∞ –¥–ª—è —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
- **YandexGPT** —á–µ—Ä–µ–∑ Responses API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤
- **YDB** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- **LangGraph** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
- **SpeechKit STT** –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **Object Storage** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å–ª—É–≥–∞—Ö

–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ—á–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:
1. Responses API ‚Üí GigaChat API
2. YDB ‚Üí Cloud.ru Database
3. SpeechKit STT ‚Üí Cloud.ru Speech Recognition
4. Object Storage ‚Üí Cloud.ru Object Storage
5. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –±–µ–∑ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–¥–µ–ª–æ–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏.
