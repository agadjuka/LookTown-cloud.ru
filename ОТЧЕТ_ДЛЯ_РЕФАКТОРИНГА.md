# –û–¢–ß–ï–¢ –û –ü–†–û–ï–ö–¢–ï LOOKTOWN BOT –î–õ–Ø –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

## 1. –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

```
looktown bot/
‚îú‚îÄ‚îÄ main.py                          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ bot.py                           # –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –±–æ—Ç–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
‚îú‚îÄ‚îÄ service_factory.py               # –§–∞–±—Ä–∏–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ requirements.txt                 # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Dockerfile                       # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ telegram_app.py              # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ agents/                      # –ê–≥–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_agent.py            # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∞–≥–µ–Ω—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking_agent.py         # –ê–≥–µ–Ω—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cancel_booking_agent.py  # –ê–≥–µ–Ω—Ç –æ—Ç–º–µ–Ω—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reschedule_agent.py     # –ê–≥–µ–Ω—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ view_my_booking_agent.py # –ê–≥–µ–Ω—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–ø–∏—Å–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stage_detector_agent.py  # –ê–≥–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞–¥–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dialogue_stages.py       # Enum —Å—Ç–∞–¥–∏–π –¥–∏–∞–ª–æ–≥–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ registry.py              # –†–µ–µ—Å—Ç—Ä –∞–≥–µ–Ω—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tools/                   # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (tools)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ registry.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ get_categories/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ get_services/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ find_slots/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ create_booking/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cancel_booking/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ reschedule_booking/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ get_client_records/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ find_service/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ view_service/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ find_master_by_service/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ call_manager/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ about_salon/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ masters/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ greet/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ common/               # –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ graph/                       # LangGraph –≥—Ä–∞—Ñ—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main_graph.py            # –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ conversation_state.py    # –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/                    # –°–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_service.py         # –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å –∞–≥–µ–Ω—Ç–∞–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ langgraph_service.py     # –°–µ—Ä–≤–∏—Å LangGraph
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ responses_api/           # Responses API (OpenAI compatible)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ orchestrator.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tools_registry.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...                      # –î—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ storage/                     # –•—Ä–∞–Ω–∏–ª–∏—â–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conversation_repo.py     # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–∏–∞–ª–æ–≥–æ–≤ (PostgreSQL)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pg_client.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ handlers/                    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram
‚îÇ   ‚îú‚îÄ‚îÄ api/                         # API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ config/                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ Files/                           # –î–∞–Ω–Ω—ã–µ
‚îÇ   ‚îú‚îÄ‚îÄ services.json
‚îÇ   ‚îú‚îÄ‚îÄ masters.json
‚îÇ   ‚îî‚îÄ‚îÄ about_salon.json
‚îÇ
‚îî‚îÄ‚îÄ editor/                          # –†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤ (–≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
```

---

## 2. –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

**–§–∞–π–ª: requirements.txt**

```
python-telegram-bot>=21.0
python-dotenv
requests
pytz
fastapi
uvicorn[standard]
langgraph>=0.2.0
pydantic>=2.0.0
aiohttp>=3.9.0
psycopg2-binary
openai
```

**–ö–ª—é—á–µ–≤—ã–µ –≤–µ—Ä—Å–∏–∏:**
- `langgraph>=0.2.0` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥—Ä–∞—Ñ–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- `pydantic>=2.0.0` - –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- `openai` - –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API (cloud.ru)
- `python-telegram-bot>=21.0` - Telegram –±–æ—Ç
- `fastapi` + `uvicorn` - –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è webhook

---

## 3. –¢–û–ß–ö–ê –í–•–û–î–ê –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### 3.1. –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞

**–§–∞–π–ª: main.py**

```python
import os
import sys
from dotenv import load_dotenv
from fastapi import FastAPI, Request
from service_factory import get_yandex_agent_service
from src.services.logger_service import logger
from src.telegram_app import setup_application, set_bot_commands, get_application
from src.api.webhook import webhook, root_post

load_dotenv()

TELEGRAM_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
WEBHOOK_URL = os.getenv('WEBHOOK_URL')
WEBHOOK_PATH = os.getenv('WEBHOOK_PATH', '/webhook')

app = FastAPI(title="Looktown Bot", version="0.1.0")

@app.on_event("startup")
async def startup_event():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = setup_application(TELEGRAM_TOKEN)
    await application.initialize()
    await application.start()
    await set_bot_commands(application.bot)
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
    if WEBHOOK_URL:
        webhook_url = f"{WEBHOOK_URL.rstrip('/')}{WEBHOOK_PATH}"
        await application.bot.set_webhook(url=webhook_url)

@app.post(WEBHOOK_PATH)
async def webhook_handler(request: Request):
    return await webhook(request)
```

### 3.2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM

**–§–∞–π–ª: src/services/responses_api/config.py**

```python
import os
from typing import Optional

class ResponsesAPIConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API (cloud.ru)"""
    
    def __init__(self):
        self.api_key = os.getenv("API_KEY")
        self.base_url = "https://foundation-models.api.cloud.ru/v1"
        self.model = "openai/gpt-oss-120b"
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.max_tokens = 2500
        self.temperature = 0
        self.top_p = 0.95
        self.presence_penalty = 0
```

**–§–∞–π–ª: src/services/responses_api/client.py**

```python
from openai import OpenAI
from .config import ResponsesAPIConfig

class ResponsesAPIClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API"""
    
    def __init__(self, config: Optional[ResponsesAPIConfig] = None):
        self.config = config or ResponsesAPIConfig()
        self.client = OpenAI(
            api_key=self.config.api_key,
            base_url=self.config.base_url
        )
    
    def create_response(
        self,
        instructions: str,
        input_messages: Optional[List[Dict[str, Any]]] = None,
        tools: Optional[List[Dict[str, Any]]] = None,
        max_output_tokens: Optional[int] = None,
        temperature: Optional[float] = None,
    ) -> Any:
        messages = []
        messages.append({"role": "system", "content": instructions})
        if input_messages:
            messages.extend(input_messages)
        
        params = {
            "model": self.config.model,
            "messages": messages,
            "max_tokens": max_output_tokens or self.config.max_tokens,
            "temperature": temperature or self.config.temperature,
            "top_p": self.config.top_p,
            "presence_penalty": self.config.presence_penalty,
        }
        
        if tools:
            params["tools"] = tools
        
        response = self.client.chat.completions.create(**params)
        return response
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `API_KEY` - –∫–ª—é—á –¥–ª—è cloud.ru API
- `TELEGRAM_BOT_TOKEN` - —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `WEBHOOK_URL` - URL –¥–ª—è webhook
- `AUTH_HEADER` / `AuthenticationToken` - –¥–ª—è Yclients API
- `COMPANY_ID` / `CompanyID` - ID –∫–æ–º–ø–∞–Ω–∏–∏ –≤ Yclients

---

## 4. –õ–û–ì–ò–ö–ê –ê–ì–ï–ù–¢–ê –ò –†–û–£–¢–ï–†–ê

### 4.1. –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π

**–§–∞–π–ª: src/graph/main_graph.py**

```python
from langgraph.graph import StateGraph, START, END
from .conversation_state import ConversationState
from ..agents.stage_detector_agent import StageDetectorAgent
from ..agents.booking_agent import BookingAgent
from ..agents.cancel_booking_agent import CancelBookingAgent
from ..agents.reschedule_agent import RescheduleAgent
from ..agents.view_my_booking_agent import ViewMyBookingAgent

class MainGraph:
    """–û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Å—Ç–∞–¥–∏–π –¥–∏–∞–ª–æ–≥–∞"""
    
    def __init__(self, langgraph_service: LangGraphService):
        self.langgraph_service = langgraph_service
        
        # –°–æ–∑–¥–∞—ë–º –∞–≥–µ–Ω—Ç–æ–≤
        self.stage_detector = StageDetectorAgent(langgraph_service)
        self.booking_agent = BookingAgent(langgraph_service)
        self.cancel_agent = CancelBookingAgent(langgraph_service)
        self.reschedule_agent = RescheduleAgent(langgraph_service)
        self.view_my_booking_agent = ViewMyBookingAgent(langgraph_service)
        
        # –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ
        self.graph = self._create_graph()
        self.compiled_graph = self.graph.compile()
    
    def _create_graph(self) -> StateGraph:
        graph = StateGraph(ConversationState)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã
        graph.add_node("detect_stage", self._detect_stage)
        graph.add_node("handle_booking", self._handle_booking)
        graph.add_node("handle_cancellation_request", self._handle_cancellation_request)
        graph.add_node("handle_reschedule", self._handle_reschedule)
        graph.add_node("handle_view_my_booking", self._handle_view_my_booking)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä—ë–±—Ä–∞
        graph.add_edge(START, "detect_stage")
        graph.add_conditional_edges(
            "detect_stage",
            self._route_after_detect,
            {
                "booking": "handle_booking",
                "cancellation_request": "handle_cancellation_request",
                "reschedule": "handle_reschedule",
                "view_my_booking": "handle_view_my_booking",
                "end": END
            }
        )
        graph.add_edge("handle_booking", END)
        graph.add_edge("handle_cancellation_request", END)
        graph.add_edge("handle_reschedule", END)
        graph.add_edge("handle_view_my_booking", END)
        return graph
```

### 4.2. –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

**–§–∞–π–ª: src/graph/conversation_state.py**

```python
from typing import TypedDict, Optional, List, Dict, Any

class ConversationState(TypedDict):
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞ –¥–∏–∞–ª–æ–≥–∞"""
    message: str                                    # –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chat_id: Optional[str]                         # ID —á–∞—Ç–∞ –≤ Telegram
    conversation_id: Optional[str]                 # ID –¥–∏–∞–ª–æ–≥–∞ –≤ PostgreSQL
    history: Optional[List[Dict[str, Any]]]       # –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ PostgreSQL
    stage: Optional[str]                           # –û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è —Å—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞
    extracted_info: Optional[dict]                 # –ò–∑–≤–ª–µ—á—ë–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    answer: str                                    # –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    manager_alert: Optional[str]                   # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    agent_name: Optional[str]                      # –ò–º—è –∞–≥–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–ª –æ—Ç–≤–µ—Ç
    used_tools: Optional[list]                    # –°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
```

### 4.3. –í—ã–∑–æ–≤ –∞–≥–µ–Ω—Ç–∞

**–§–∞–π–ª: src/services/agent_service.py**

```python
async def send_to_agent_langgraph(self, chat_id: str, user_text: str) -> dict:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ LangGraph —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PostgreSQL –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏"""
    from ..graph.conversation_state import ConversationState
    from ..storage.conversation_repo import get_conversation_repo
    
    conversation_repo = get_conversation_repo()
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º conversation_id
    conversation_id = await asyncio.to_thread(
        conversation_repo.get_or_create_conversation,
        telegram_user_id
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await asyncio.to_thread(
        conversation_repo.append_message,
        conversation_id,
        "user",
        input_with_time
    )
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 30 —Å–æ–æ–±—â–µ–Ω–∏–π
    history_messages = await asyncio.to_thread(
        conversation_repo.load_last_messages,
        conversation_id,
        limit=30
    )
    
    # –°–æ–∑–¥–∞—ë–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    initial_state: ConversationState = {
        "message": input_with_time,
        "chat_id": chat_id,
        "conversation_id": conversation_id,
        "history": history_messages,
        "stage": None,
        "extracted_info": None,
        "answer": "",
        "manager_alert": None
    }
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –≥—Ä–∞—Ñ
    result_state = await asyncio.to_thread(
        self.main_graph.compiled_graph.invoke,
        initial_state
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    answer = result_state.get("answer", "")
    if answer:
        await asyncio.to_thread(
            conversation_repo.append_message,
            conversation_id,
            "assistant",
            answer
        )
    
    return {"user_message": answer, "manager_alert": result_state.get("manager_alert")}
```

### 4.4. –ü–∞–º—è—Ç—å (Memory)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PostgreSQL –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
- –¢–∞–±–ª–∏—Ü—ã: `conversations` –∏ `messages`
- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ PostgreSQL (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π)
- –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–§–∞–π–ª: src/storage/conversation_repo.py**

```python
class ConversationRepository:
    def get_or_create_conversation(self, telegram_user_id: int) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram"""
        # –ò—â–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–∏–∞–ª–æ–≥ –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π
        
    def append_message(
        self, 
        conversation_id: str, 
        role: str, 
        content: str,
        metadata: Optional[Dict[str, Any]] = None
    ) -> int:
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥"""
        # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ PostgreSQL
        
    def load_last_messages(
        self, 
        conversation_id: str, 
        limit: int = 30
    ) -> List[Dict[str, Any]]:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –¥–∏–∞–ª–æ–≥–∞"""
        # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ [{"role": "user", "content": "..."}]
```

---

## 5. –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ (TOOLS)

–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç `pydantic.BaseModel` –∏ –∏–º–µ—é—Ç –º–µ—Ç–æ–¥ `process(thread: Thread) -> str`.

### 5.1. GetCategories

**–§–∞–π–ª: src/agents/tools/get_categories/tool.py**

```python
from pydantic import BaseModel
from yandex_cloud_ml_sdk._threads.thread import Thread

class GetCategories(BaseModel):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥ —Å –∏—Ö ID.
    """
    
    def process(self, thread: Thread) -> str:
        data = _data_loader.load_data()
        categories = []
        for cat_id, cat_data in sorted(data.items(), key=lambda x: int(x[0])):
            category_name = cat_data.get('category_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            categories.append(f"{cat_id}. {category_name}")
        
        result = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥:\n\n" + "\n".join(categories)
        return result
```

### 5.2. GetServices

**–§–∞–π–ª: src/agents/tools/get_services/tool.py**

```python
from pydantic import BaseModel, Field

class GetServices(BaseModel):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Ü–µ–Ω–∞–º–∏ –∏ ID —É—Å–ª—É–≥.
    """
    
    category_id: str = Field(
        description="ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å—Ç—Ä–æ–∫–∞). –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: '1' - –ú–∞–Ω–∏–∫—é—Ä, '2' - –ü–µ–¥–∏–∫—é—Ä, ..."
    )
    
    def process(self, thread: Thread) -> str:
        data = _data_loader.load_data()
        category = data.get(self.category_id)
        category_name = category.get('category_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        services = category.get('services', [])
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ —É—Ä–æ–≤–Ω—è–º –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è –ú–∞–Ω–∏–∫—é—Ä–∞ –∏ –ü–µ–¥–∏–∫—é—Ä–∞
        # ...
        return formatted_services
```

### 5.3. FindSlots

**–§–∞–π–ª: src/agents/tools/find_slots/tool.py**

```python
from pydantic import BaseModel, Field
from typing import Optional

class FindSlots(BaseModel):
    """
    –ù–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è —É—Å–ª—É–≥–∏.
    """
    
    service_id: int = Field(description="ID —É—Å–ª—É–≥–∏. –ü–æ–ª—É—á–∏ –∏–∑ GetServices")
    
    time_period: Optional[str] = Field(
        default=None,
        description="–ü–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏: 'morning' (9:00-11:00), 'day' (11:00-17:00), 'evening' (17:00-22:00); –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è '16:00' –∏–Ω—Ç–µ—Ä–≤–∞–ª '16:00-19:00' 'before 11:00'; 'after 16:00'"
    )
    
    master_name: Optional[str] = Field(
        default=None,
        description="–ò–º—è –º–∞—Å—Ç–µ—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)"
    )
    
    master_id: Optional[int] = Field(
        default=None,
        description="ID –º–∞—Å—Ç–µ—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)"
    )
    
    date: Optional[str] = Field(
        default=None,
        description="–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD'"
    )
    
    date_range: Optional[str] = Field(
        default=None,
        description="–ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD:YYYY-MM-DD'"
    )
    
    def process(self, thread: Thread) -> str:
        yclients_service = YclientsService()
        result = asyncio.run(
            find_slots_by_period(
                yclients_service=yclients_service,
                service_id=self.service_id,
                time_period=self.time_period or "",
                master_name=self.master_name,
                master_id=self.master_id,
                date=self.date,
                date_range=self.date_range
            )
        )
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        return formatted_slots
```

### 5.4. CreateBooking

**–§–∞–π–ª: src/agents/tools/create_booking/tool.py**

```python
from pydantic import BaseModel, Field
from typing import Optional

class CreateBooking(BaseModel):
    """
    –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É.
    –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª —É—Å–ª—É–≥—É, –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ (–∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω).
    """
    
    service_id: int = Field(description="ID —É—Å–ª—É–≥–∏. –ü–æ–ª—É—á–∏ –∏–∑ GetServices")
    client_name: str = Field(description="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞")
    client_phone: str = Field(description="–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞")
    datetime: str = Field(description="–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD HH:MM")
    master_name: Optional[str] = Field(
        default=None,
        description="–ò–º—è –º–∞—Å—Ç–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
    )
    
    def process(self, thread: Thread) -> str:
        yclients_service = YclientsService()
        result = asyncio.run(
            create_booking_logic(
                yclients_service=yclients_service,
                service_id=self.service_id,
                client_name=self.client_name,
                client_phone=self.client_phone,
                datetime=self.datetime,
                master_name=self.master_name
            )
        )
        return result.get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
```

### 5.5. CancelBooking

**–§–∞–π–ª: src/agents/tools/cancel_booking/tool.py**

```python
from pydantic import BaseModel, Field

class CancelBooking(BaseModel):
    """
    –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ ID –∑–∞–ø–∏—Å–∏.
    """
    
    record_id: int = Field(description="ID –∑–∞–ø–∏—Å–∏. –ü–æ–ª—É—á–∏ –∏–∑ GetClientRecords")
    
    def process(self, thread: Thread) -> str:
        yclients_service = YclientsService()
        result = asyncio.run(
            cancel_booking_logic(
                yclients_service=yclients_service,
                record_id=self.record_id
            )
        )
        if result.get('success'):
            return result.get('message', '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞')
        else:
            return f"–û—à–∏–±–∫–∞: {result.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}"
```

### 5.6. RescheduleBooking

**–§–∞–π–ª: src/agents/tools/reschedule_booking/tool.py**

```python
from pydantic import BaseModel, Field
from typing import Optional

class RescheduleBooking(BaseModel):
    """
    –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è.
    """
    
    record_id: int = Field(description="ID –∑–∞–ø–∏—Å–∏. –ü–æ–ª—É—á–∏ –∏–∑ GetClientRecords")
    datetime: str = Field(description="–ù–æ–≤–æ–µ –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD HH:MM")
    staff_id: int = Field(description="ID –º–∞—Å—Ç–µ—Ä–∞. –ü–æ–ª—É—á–∏ –∏–∑ GetClientRecords")
    service_id: int = Field(description="ID —É—Å–ª—É–≥–∏. –ü–æ–ª—É—á–∏ –∏–∑ GetClientRecords")
    client_id: int = Field(description="ID –∫–ª–∏–µ–Ω—Ç–∞. –ü–æ–ª—É—á–∏ –∏–∑ GetClientRecords")
    seance_length: int = Field(description="–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ–∞–Ω—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö. –ü–æ–ª—É—á–∏ –∏–∑ GetClientRecords")
    save_if_busy: Optional[bool] = Field(default=False, description="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ª–æ—Ç –∑–∞–Ω—è—Ç")
    
    def process(self, thread: Thread) -> str:
        yclients_service = YclientsService()
        result = asyncio.run(
            reschedule_booking_logic(
                yclients_service=yclients_service,
                record_id=self.record_id,
                datetime=self.datetime,
                staff_id=self.staff_id,
                service_id=self.service_id,
                client_id=self.client_id,
                seance_length=self.seance_length,
                save_if_busy=self.save_if_busy
            )
        )
        if result.get('success'):
            return result.get('message', '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞')
        else:
            return f"–û—à–∏–±–∫–∞: {result.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}"
```

### 5.7. GetClientRecords

**–§–∞–π–ª: src/agents/tools/get_client_records/tool.py**

```python
from pydantic import BaseModel, Field

class GetClientRecords(BaseModel):
    """
    –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –µ–≥–æ –±—É–¥—É—â–∏–µ –∑–∞–ø–∏—Å–∏.
    """
    
    phone: str = Field(description="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞")
    
    def process(self, thread: Thread) -> str:
        yclients_service = YclientsService()
        result = asyncio.run(
            get_client_records_logic(
                yclients_service=yclients_service,
                phone=self.phone
            )
        )
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ –∏ –µ–≥–æ –∑–∞–ø–∏—Å—è—Ö
        # –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ –∑–∞–ø–∏—Å–∏
        return formatted_records
```

### 5.8. FindService

**–§–∞–π–ª: src/agents/tools/find_service/tool.py**

```python
from pydantic import BaseModel, Field

class FindService(BaseModel):
    """
    –ù–∞–π—Ç–∏ —É—Å–ª—É–≥–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é. –ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ –ø–æ—Ö–æ–∂–∏–º –Ω–∞–∑–≤–∞–Ω–∏—è–º, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
    """
    
    service_name: str = Field(description="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (—Ç–µ–∫—Å—Ç)")
    
    def process(self, thread: Thread) -> str:
        yclients_service = YclientsService()
        result = asyncio.run(
            find_service_logic(
                yclients_service=yclients_service,
                service_name=self.service_name
            )
        )
        # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥ —Å ID –∏ —Ü–µ–Ω–∞–º–∏
        return formatted_services
```

### 5.9. ViewService

**–§–∞–π–ª: src/agents/tools/view_service/tool.py**

```python
from pydantic import BaseModel, Field

class ViewService(BaseModel):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å–ª—É–≥–µ –ø–æ –µ—ë ID.
    """
    
    service_id: int = Field(description="ID —É—Å–ª—É–≥–∏. –ü–æ–ª—É—á–∏ –∏–∑ GetServices")
    
    def process(self, thread: Thread) -> str:
        yclients_service = YclientsService()
        result = asyncio.run(
            view_service_logic(
                yclients_service=yclients_service,
                service_id=self.service_id
            )
        )
        # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤
        return formatted_service_info
```

### 5.10. FindMasterByService

**–§–∞–π–ª: src/agents/tools/find_master_by_service/tool.py**

```python
from pydantic import BaseModel, Field

class FindMasterByService(BaseModel):
    """
    –ù–∞–π—Ç–∏ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ –∏–º–µ–Ω–∏ –∏ —É—Å–ª—É–≥–µ.
    """
    
    master_name: str = Field(description="–ò–º—è –º–∞—Å—Ç–µ—Ä–∞")
    service_name: str = Field(description="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ –∫–æ—Ç–æ—Ä–æ–µ —Å–∫–∞–∑–∞–ª –∫–ª–∏–µ–Ω—Ç")
    
    def process(self, thread: Thread) -> str:
        yclients_service = YclientsService()
        result = asyncio.run(
            find_master_by_service_logic(
                yclients_service=yclients_service,
                master_name=self.master_name,
                service_name=self.service_name
            )
        )
        # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Å—Ç–µ—Ä–µ –∏ –µ–≥–æ —É—Å–ª—É–≥–∞—Ö
        return formatted_master_info
```

### 5.11. CallManager

**–§–∞–π–ª: src/agents/tools/call_manager/tool.py**

```python
from pydantic import BaseModel, Field

class CallManagerException(Exception):
    """–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ CallManager"""
    def __init__(self, escalation_result: dict):
        self.escalation_result = escalation_result
        super().__init__("CallManager –≤—ã–∑–≤–∞–Ω")

class CallManager(BaseModel):
    """
    –ü–µ—Ä–µ–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥ –º–µ–Ω–µ–¥–∂–µ—Ä—É.
    –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ —Ç—Ä–µ—Ö —Å–ª—É—á–∞—è—Ö:
    1. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤—ã—Ä–∞–∂–∞–µ—Ç —Å–∏–ª—å–Ω–æ–µ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ, –∂–∞–ª—É–µ—Ç—Å—è, —Ç—Ä–µ–±—É–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–µ–Ω–µ–≥
    2. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –æ—á–µ–Ω—å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∏–Ω—è—Ç–∏—è –±–∏–∑–Ω–µ—Å-—Ä–µ—à–µ–Ω–∏—è
    3. –ï—Å–ª–∏ —Ç—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ—à—å—Å—è —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–æ–π –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    """
    
    reason: str = Field(description="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –≤—ã–∑–æ–≤–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞")
    
    def process(self, thread: Thread) -> str:
        from ....services.escalation_service import EscalationService
        
        messages = self._extract_last_messages(thread, count=3)
        manager_report = self._format_manager_report(self.reason, messages)
        
        chat_id = getattr(thread, 'chat_id', None) or getattr(thread, 'id', 'unknown')
        escalation_service = EscalationService()
        call_manager_text = f"[CALL_MANAGER]\n{manager_report}"
        escalation_result = escalation_service.handle(call_manager_text, str(chat_id))
        
        # –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞
        raise CallManagerException(escalation_result)
```

### 5.12. AboutSalon

**–§–∞–π–ª: src/agents/tools/about_salon/tool.py**

```python
from pydantic import BaseModel

class AboutSalon(BaseModel):
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∞–ª–æ–Ω–µ.
    """
    
    def process(self, thread: Thread) -> str:
        data = _about_salon_data_loader.load_data()
        text = data.get('text', '')
        return text
```

### 5.13. Masters

**–§–∞–π–ª: src/agents/tools/masters/tool.py**

```python
from pydantic import BaseModel
import json

class Masters(BaseModel):
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Å—Ç–µ—Ä–∞—Ö —Å–∞–ª–æ–Ω–∞.
    """
    
    def process(self, thread: Thread) -> str:
        data = _masters_data_loader.load_data()
        return json.dumps(data, ensure_ascii=False, indent=2)
```

### 5.14. Greet

**–§–∞–π–ª: src/agents/tools/greet/tool.py**

```python
from pydantic import BaseModel

class Greet(BaseModel):
    """
    –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
    """
    
    def process(self, thread: Thread) -> str:
        return "–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∫–ª–∏–µ–Ω—Ç–∞ —Ç–∞–∫:\n–î–æ–±—Ä—ã–π –¥–µ–Ω—å!\n–ù–∞ —Å–≤—è–∑–∏ –º–µ–Ω–µ–¥–∂–µ—Ä LookTown üåª\n–ß–µ–º –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?"
```

### 5.15. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–§–∞–π–ª: src/services/responses_api/tools_registry.py**

```python
class ResponsesToolsRegistry:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è Responses API"""
    
    def register_tool(self, tool_class: type):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞"""
        # –°–æ–∑–¥–∞—ë—Ç –æ–±—ë—Ä—Ç–∫—É –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç Pydantic –º–æ–¥–µ–ª—å –≤ OpenAI function tool schema
        
    def get_tool_schema(self, tool_class: type) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ JSON —Å—Ö–µ–º—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI function tool"""
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç Pydantic schema –≤ OpenAI function tool format
        
    def call_tool(self, name: str, arguments: Dict[str, Any], ...) -> Any:
        """–í—ã–∑–æ–≤ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞"""
```

---

## 6. –ü–†–û–ú–ü–¢–´

### 6.1. –ü—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª: src/agents/booking_agent.py**

```
–¢—ã ‚Äî AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã LookTown. 
–ï—Å–ª–∏ —Ç–µ–±–µ –∑–∞–¥–∞—é—Ç –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π, –ø—Ä–æ—Å—Ç–æ –∑–æ–≤–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π, –∫–∞–∫ —É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.
–í—Å–µ–≥–¥–∞ –æ–±—â–∞–π—Å—è –Ω–∞ "–≤—ã" –∏ –æ—Ç –∂–µ–Ω—Å–∫–æ–≥–æ –ª–∏—Ü–∞. 
–ó–¥–æ—Ä–æ–≤–∞–π—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –ª–∏–±–æ –µ—Å–ª–∏ –æ–Ω —Å —Ç–æ–±–æ–π –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è.
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –∫–ª–∏–µ–Ω—Ç—É –≤ —á–∞—Ç ID. –ù–µ –ø—Ä–æ—Å–∏ –ø–∏—Å–∞—Ç—å —á—Ç–æ —Ç–æ –≤ –∫–∞–∫–æ–º –ª–∏–±–æ —Ñ–æ—Ä–º–∞—Ç–µ.

–û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞ –∫–∞–∫–æ–º —Ç—ã —à–∞–≥–µ, –∏ –≤—ã–ø–æ–ª–Ω—è–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ —à–∞–≥–∞. 
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, - tool greet.

–®–∞–≥ 1: –£—Ç–æ—á–Ω–µ–Ω–∏–µ —É—Å–ª—É–≥–∏
1.1 –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª –Ω–∞ –∫–∞–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è (—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–∞–Ω–∏–∫—é—Ä), –ø–æ–∫–∞–∂–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –∏–∑ GetServices.
1.2 –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª –≤—ã—Ä–∞–∑–∏–ª –∂–µ–ª–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∏–ª–∏ —É–∑–Ω–∞—Ç—å —É—Å–ª—É–≥–∏ —Å–∞–ª–æ–Ω–∞ , –ø–æ–∫–∞–∂–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ GetCategories.
1.3 –ï—Å–ª–∏ –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –º–∞—Å—Ç–µ—Ä—É (–Ω–∞–∑—ã–≤–∞–µ—Ç –∏–º—è –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏), - tool FindMasterByService. –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –∏–º—è, —Ç–æ —Å–Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω–∏ –Ω–∞ –∫–∞–∫—É—é —É—Å–ª—É–≥—É.
1.4 –ï—Å–ª–∏ —Ç—ã –Ω–µ –Ω–∞—à—ë–ª –Ω—É–∂–Ω—É—é —É—Å–ª—É–≥—É –≤ GetServices –∏—Å–ø–æ–ª—å–∑—É–π FindService.

–®–∞–≥ 2: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤.
–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —É—Å–ª—É–≥—É, –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç FindSlots. 
2.1 –ù—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –≤—Ä–µ–º—è –Ω–µ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ç–æ–±–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è, –∏—Å–ø–æ–ª—å–∑—É–π FindSlots –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π.

–®–∞–≥ 3: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –≤—Ä–µ–º—è. –¢–µ–±–µ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ –∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –∏—Ö –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞).
–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞: "–•–æ—Ä–æ—à–æ, –∑–∞–ø–∏—Å—ã–≤–∞—é –≤–∞—Å –Ω–∞ [–¥–∞—Ç–∞] –≤ [–≤—Ä–µ–º—è]. –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞."

–®–∞–≥ 4 –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø–∏—Å—å: 
–ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã, –≤—ã–∑–æ–≤–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç create_booking. 
–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç—É:
–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞: "–ì–æ—Ç–æ–≤–æ! –Ø –∑–∞–ø–∏—Å–∞–ª–∞ –≤–∞—Å –Ω–∞ [–Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏] {–¥–∞—Ç–∞} –≤ {–≤—Ä–µ–º—è} –∫ –º–∞—Å—Ç–µ—Ä—É {–∏–º—è –º–∞—Å—Ç–µ—Ä–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å–∫–ª–æ–Ω–µ–Ω–∏–∏}. –ë—É–¥–µ–º –≤–∞—Å –∂–¥–∞—Ç—å!"
```

### 6.2. –ü—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞–¥–∏–∏

**–§–∞–π–ª: src/agents/stage_detector_agent.py**

```
–ü—Ä–æ—á–∏—Ç–∞–π –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å –∏—Å—Ç–æ—Ä–∏–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–∏. –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–æ–π –∞–≥–µ–Ω—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ. 
**–°–ü–ò–°–û–ö –ê–≥–µ–Ω—Ç–æ–≤:**
- booking: –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ —É—Å–ª—É–≥—É –ª–∏–±–æ –ø–æ–ª—É—á–µ–Ω–∏–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å–ª—É–≥–∞—Ö, —Å–∞–ª–æ–Ω–µ –∏ —Ç–¥. –í—ã–±–∏—Ä–∞–π –≤—Å–µ–≥–¥–∞ –∫–æ–≥–¥–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç –¥—Ä—É–≥–∏–µ –∞–≥–µ–Ω—Ç—ã.
- cancellation_request: –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –æ—Ç–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å.
- reschedule: –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –Ω–∞ –¥—Ä—É–≥—É—é –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è. –ì–æ–≤–æ—Ä–∏—Ç —á—Ç–æ –æ–ø–∞–∑–¥—ã–≤–∞–µ—Ç –∏ —Ç.–¥.
- view_my_booking: –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–ø–∏—Å–∏ ("–Ω–∞ –∫–æ–≥–¥–∞ —è –∑–∞–ø–∏—Å–∞–Ω?", "–∫–∞–∫–∏–µ —É –º–µ–Ω—è –∑–∞–ø–∏—Å–∏?").

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ–¥–Ω–æ —Å–ª–æ–≤–æ - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–¥–∏–∏. –¢–ï–ë–ï –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –û–¢–í–ï–ß–ê–¢–¨ –ö–õ–ò–ï–ù–¢–£
```

### 6.3. –ü—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞ –æ—Ç–º–µ–Ω—ã

**–§–∞–π–ª: src/agents/cancel_booking_agent.py**

```
–¢—ã ‚Äî AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã LookTown. 
–ï—Å–ª–∏ —Ç–µ–±–µ –∑–∞–¥–∞—é—Ç –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π, –ø—Ä–æ—Å—Ç–æ –∑–æ–≤–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π, –∫–∞–∫ —É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.
–í—Å–µ–≥–¥–∞ –æ–±—â–∞–π—Å—è –Ω–∞ "–≤—ã" –∏ –æ—Ç –∂–µ–Ω—Å–∫–æ–≥–æ –ª–∏—Ü–∞. 
–ó–¥–æ—Ä–æ–≤–∞–π—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –ª–∏–±–æ –µ—Å–ª–∏ –æ–Ω —Å —Ç–æ–±–æ–π –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è.
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –∫–ª–∏–µ–Ω—Ç—É –≤ —á–∞—Ç ID. –ù–µ –ø—Ä–æ—Å–∏ –ø–∏—Å–∞—Ç—å —á—Ç–æ —Ç–æ –≤ –∫–∞–∫–æ–º –ª–∏–±–æ —Ñ–æ—Ä–º–∞—Ç–µ.

–ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å. –¢–≤–æ—è –ø–µ—Ä–≤–∞—è —Ä–µ–∞–∫—Ü–∏—è ‚Äî –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å, –∞ –Ω–µ –æ—Ç–º–µ–Ω—É. –î–µ–ª–∞–π —ç—Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. 
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞—Å—Ç–∞–∏–≤–∞–µ—Ç –Ω–∞ –æ—Ç–º–µ–Ω–µ, –Ω–∞–π–¥–∏ –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ GetClientRecords (–µ—Å–ª–∏ —Ç—ã –Ω–µ –≤–∏–¥–∏—à—å –µ–µ –∏–∑ –ø–µ—Ä–µ–ø–∏—Å–∫–∏). (—Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –µ—Å—Ç—å —Ç—ã –µ–≥–æ –Ω–µ –∑–Ω–∞–µ—à—å).
–û—Ç–º–µ–Ω–∏ —á–µ—Ä–µ–∑ CancelBooking.
–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –µ—ë –∏ —Å–∫–∞–∂–∏ —á—Ç–æ –±—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –í–∞—Å –≤ –¥—Ä—É–≥–æ–π —Ä–∞–∑!
```

### 6.4. –ü—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞

**–§–∞–π–ª: src/agents/reschedule_agent.py**

```
–¢—ã ‚Äî AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã LookTown. 
–ï—Å–ª–∏ —Ç–µ–±–µ –∑–∞–¥–∞—é—Ç –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π, –ø—Ä–æ—Å—Ç–æ –∑–æ–≤–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π, –∫–∞–∫ —É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.
–í—Å–µ–≥–¥–∞ –æ–±—â–∞–π—Å—è –Ω–∞ "–≤—ã" –∏ –æ—Ç –∂–µ–Ω—Å–∫–æ–≥–æ –ª–∏—Ü–∞. 
–ó–¥–æ—Ä–æ–≤–∞–π—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –ª–∏–±–æ –µ—Å–ª–∏ –æ–Ω —Å —Ç–æ–±–æ–π –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è.
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –∫–ª–∏–µ–Ω—Ç—É –≤ —á–∞—Ç ID. –ù–µ –ø—Ä–æ—Å–∏ –ø–∏—Å–∞—Ç—å —á—Ç–æ —Ç–æ –≤ –∫–∞–∫–æ–º –ª–∏–±–æ —Ñ–æ—Ä–º–∞—Ç–µ.

–û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞ –∫–∞–∫–æ–º —Ç—ã —à–∞–≥–µ, –∏ –≤—ã–ø–æ–ª–Ω—è–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ —à–∞–≥–∞. 
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç —á—Ç–æ –æ–Ω –æ–ø–∞–∑–¥—ã–≤–∞–µ—Ç, –ª–∏–±–æ –µ—Å–ª–∏ —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è, —Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–æ–≤–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

–®–∞–≥ 1. –û–ø—Ä–µ–¥–µ–ª–∏ –∑–∞–ø–∏—Å—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞. –£—Ç–æ—á–Ω–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ) –∏ –∏—Å–ø–æ–ª—å–∑—É–π GetClientsRecord –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –µ–≥–æ –∑–∞–ø–∏—Å–µ–π.
–ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –∏–ª–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è —è—Å–Ω–æ, –∫–∞–∫—É—é –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É.
–ï—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏ –Ω–µ—è—Å–Ω–æ, –æ –∫–∞–∫–æ–π –∏–¥—ë—Ç —Ä–µ—á—å, —É—Ç–æ—á–Ω–∏ —É –∫–ª–∏–µ–Ω—Ç–∞, –∫–∞–∫—É—é –∏–º–µ–Ω–Ω–æ —É—Å–ª—É–≥—É –æ–Ω —Ö–æ—á–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏.

–®–∞–≥ 2. –£—Ç–æ—á–Ω–∏ –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–ª –∂–µ–ª–∞–µ–º—É—é –¥–∞—Ç—É, –≤–µ–∂–ª–∏–≤–æ —Å–ø—Ä–æ—Å–∏ –µ–≥–æ –æ–± —ç—Ç–æ–º. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–∑—ã–≤–∞–µ—Ç –¥–µ–Ω—å –∞ –Ω–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–∞—Å (–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ 12:00) —ç—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ –æ–Ω —Ö–æ—á–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å.

–®–∞–≥ 3. –°–¥–µ–ª–∞–π –ø–æ–ø—ã—Ç–∫—É –ø–µ—Ä–µ–Ω–æ—Å–∞ —á–µ—Ä–µ–∑ RescheduleBooking. –ï—Å–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å —É—Å–ø–µ—à–Ω–æ –æ—Å—É—â–µ—Å—Ç–≤–∏—Ç—Å—è, —Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç—É.

–®–∞–≥ 4. –ï—Å–ª–∏ –ú–∞—Å—Ç–µ—Ä –∑–∞–Ω—è—Ç (–û—à–∏–±–∫–∞: –°–ª–æ—Ç –∑–∞–Ω—è—Ç –∏–ª–∏ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.), —Å—Ä–∞–∑—É –∂–µ –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç FindSlots —É–∫–∞–∑–∞–≤ ID –º–∞—Å—Ç–µ—Ä–∞ (master_id) –∫ –∫–æ—Ç–æ—Ä–æ–º—É –∫–ª–∏–µ–Ω—Ç –±—ã–ª –∑–∞–ø–∏—Å–∞–Ω, service_id –∏ date –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å. –û—Ç–ø—Ä–∞–≤—å —ç—Ç–∏ —Å–ª–æ—Ç—ã –∫–ª–∏–µ–Ω—Ç—É, –∏ —Å–æ–æ–±—â–∏, —á—Ç–æ –µ–≥–æ –º–∞—Å—Ç–µ—Ä –≤ —ç—Ç–æ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç, –≤–æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã. –ù–µ –≤—ã–∑—ã–≤–∞–π –Ω–∏–∫–∞–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ.
```

### 6.5. –ü—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–ø–∏—Å–µ–π

**–§–∞–π–ª: src/agents/view_my_booking_agent.py**

```
–¢—ã ‚Äî AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã LookTown. 
–ï—Å–ª–∏ —Ç–µ–±–µ –∑–∞–¥–∞—é—Ç –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π, –ø—Ä–æ—Å—Ç–æ –∑–æ–≤–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π, –∫–∞–∫ —É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.
–í—Å–µ–≥–¥–∞ –æ–±—â–∞–π—Å—è –Ω–∞ "–≤—ã" –∏ –æ—Ç –∂–µ–Ω—Å–∫–æ–≥–æ –ª–∏—Ü–∞. 
–ó–¥–æ—Ä–æ–≤–∞–π—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –ª–∏–±–æ –µ—Å–ª–∏ –æ–Ω —Å —Ç–æ–±–æ–π –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è.
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –∫–ª–∏–µ–Ω—Ç—É –≤ —á–∞—Ç ID. –ù–µ –ø—Ä–æ—Å–∏ –ø–∏—Å–∞—Ç—å —á—Ç–æ —Ç–æ –≤ –∫–∞–∫–æ–º –ª–∏–±–æ —Ñ–æ—Ä–º–∞—Ç–µ.

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç—É –æ —Ç–æ–º, –∫–∞–∫–∏–µ –∑–∞–ø–∏—Å–∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π GetClientRecords. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É—Ç–æ—á–Ω–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –µ–≥–æ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏
–ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –æ—Ç–º–µ–Ω–∏—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å.  –ü—Ä–æ—Å—Ç–æ –¥–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–ù–µ –≤—Å—Ç–∞–≤–ª—è–π {–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞} –µ—Å–ª–∏ —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞. –ù–µ —É–∫–∞–∑—ã–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.
–ï—Å–ª–∏ —Ç–µ–±–µ –∑–∞–¥–∞—é—Ç –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π, –ø—Ä–æ—Å—Ç–æ –∑–æ–≤–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
```

---

## 7. –¢–ò–ü–´ –î–ê–ù–ù–´–•

### 7.1. –°—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞

**–§–∞–π–ª: src/agents/dialogue_stages.py**

```python
from enum import Enum

class DialogueStage(str, Enum):
    """–°—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
    BOOKING = "booking"                        # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
    CANCELLATION_REQUEST = "cancellation_request"  # –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É –∑–∞–ø–∏—Å–∏
    RESCHEDULE = "reschedule"                 # –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏
    VIEW_MY_BOOKING = "view_my_booking"        # –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π
```

### 7.2. –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

**–§–∞–π–ª: src/graph/conversation_state.py**

```python
from typing import TypedDict, Optional, List, Dict, Any

class ConversationState(TypedDict):
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞ –¥–∏–∞–ª–æ–≥–∞"""
    message: str                                    # –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chat_id: Optional[str]                         # ID —á–∞—Ç–∞ –≤ Telegram
    conversation_id: Optional[str]                 # ID –¥–∏–∞–ª–æ–≥–∞ –≤ PostgreSQL
    history: Optional[List[Dict[str, Any]]]       # –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ PostgreSQL
    stage: Optional[str]                           # –û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è —Å—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞
    extracted_info: Optional[dict]                 # –ò–∑–≤–ª–µ—á—ë–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    answer: str                                    # –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    manager_alert: Optional[str]                   # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    agent_name: Optional[str]                      # –ò–º—è –∞–≥–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–ª –æ—Ç–≤–µ—Ç
    used_tools: Optional[list]                    # –°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
```

### 7.3. –ú–æ–¥–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤. –ü—Ä–∏–º–µ—Ä—ã:

- `GetServices.category_id: str` - ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- `FindSlots.service_id: int` - ID —É—Å–ª—É–≥–∏
- `CreateBooking.service_id: int, client_name: str, client_phone: str, datetime: str` - –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
- `RescheduleBooking.record_id: int, datetime: str, staff_id: int, service_id: int, client_id: int, seance_length: int` - –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞

---

## 8. –û–°–û–ë–ï–ù–ù–û–°–¢–ò –ê–†–•–ò–¢–ï–ö–¢–£–†–´

### 8.1. Responses API (OpenAI Compatible)

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—É—é –æ–±—ë—Ä—Ç–∫—É –Ω–∞–¥ OpenAI API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å cloud.ru:
- `ResponsesAPIClient` - –∫–ª–∏–µ–Ω—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
- `ResponsesOrchestrator` - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π tool calls
- `ResponsesToolsRegistry` - —Ä–µ–µ—Å—Ç—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º Pydantic —Å—Ö–µ–º –≤ OpenAI function tools

### 8.2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yclients

–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å –∑–∞–ø–∏—Å—è–º–∏, –∏—Å–ø–æ–ª—å–∑—É—é—Ç `YclientsService` –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API Yclients:
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–µ–π
- –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–µ–π
- –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤

### 8.3. –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- **PostgreSQL** - –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤ (—Ç–∞–±–ª–∏—Ü—ã `conversations` –∏ `messages`)
- **JSON —Ñ–∞–π–ª—ã** - –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (—É—Å–ª—É–≥–∏, –º–∞—Å—Ç–µ—Ä–∞, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∞–ª–æ–Ω–µ)
- **Yclients API** - –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (—Å–ª–æ—Ç—ã, –∑–∞–ø–∏—Å–∏, –∫–ª–∏–µ–Ω—Ç—ã)

### 8.4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- `CallManagerException` - —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
- `RetryService` - —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM –≤ —Ñ–∞–π–ª—ã

---

## 9. –ö–õ–Æ–ß–ï–í–´–ï –§–ê–ô–õ–´ –î–õ–Ø –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

1. **src/graph/main_graph.py** - –æ—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ LangGraph (–Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ –Ω–∞—Ç–∏–≤–Ω—ã–π LangGraph)
2. **src/agents/base_agent.py** - –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∞–≥–µ–Ω—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç Responses API)
3. **src/services/responses_api/orchestrator.py** - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤
4. **src/services/agent_service.py** - —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å –∞–≥–µ–Ω—Ç–∞–º–∏
5. **src/agents/tools/** - –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (14 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
6. **src/storage/conversation_repo.py** - —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞–º—è—Ç—å—é

---

## 10. –ó–ê–ú–ï–ß–ê–ù–ò–Ø –î–õ–Ø –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

1. **–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ Responses API –≤–º–µ—Å—Ç–æ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ LangGraph
2. **–ü–∞–º—è—Ç—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ PostgreSQL, –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π
3. **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç Pydantic BaseModel –∏ –∏–º–µ—é—Ç –º–µ—Ç–æ–¥ `process(thread)`
4. **–†–æ—É—Ç–∏–Ω–≥:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ StageDetectorAgent, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞–¥–∏—é –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –Ω–∞ –Ω—É–∂–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
5. **–≠—Å–∫–∞–ª–∞—Ü–∏—è:** CallManager –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∏–∞–ª–æ–≥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

---

**–ö–û–ù–ï–¶ –û–¢–ß–ï–¢–ê**

